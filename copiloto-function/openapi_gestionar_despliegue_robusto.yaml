openapi: 3.1.0
info:
  title: "Gestionar Despliegue - Sistema Robusto"
  version: "2.0.0"
  description: |
    üöÄ **ENDPOINT ROBUSTO Y SEM√ÅNTICO PARA GESTI√ìN DE DESPLIEGUES**
    
    Sistema completamente adaptativo que acepta cualquier formato de payload y se adapta
    din√°micamente sin rechazar requests por condiciones predefinidas.
    
    ## Caracter√≠sticas Principales
    - ‚úÖ **Validador din√°mico** que acepta m√∫ltiples formatos
    - ‚úÖ **Detecci√≥n autom√°tica** de acci√≥n, entorno, target
    - ‚úÖ **Respuestas estructuradas** con sugerencias adaptativas
    - ‚úÖ **Compatible** con Foundry, CodeGPT, CLI sin conflictos
    - ‚úÖ **Tolerante** al desorden de par√°metros
    - ‚úÖ **Manejo de errores** que gu√≠a a agentes para autocorrecci√≥n

paths:
  /api/gestionar-despliegue:
    post:
      summary: "Gesti√≥n robusta de despliegues"
      description: |
        Endpoint ultra-flexible que acepta cualquier formato de payload para gestionar despliegues.
        
        **Formatos de payload soportados:**
        - JSON est√°ndar en body
        - JSON en raw body
        - Query parameters
        - Payload vac√≠o (usa defaults)
        
        **Acciones soportadas:**
        - `detectar` / `detect` / `check` - Detecta cambios y estado
        - `preparar` / `prepare` / `build` / `validate` - Prepara script de despliegue
        - `desplegar` / `deploy` - Ejecuta despliegue completo
        - `rollback` / `revert` - Rollback a versi√≥n anterior
        - `estado` / `status` / `info` - Obtiene estado actual
        - `actualizar` / `update` / `upgrade` - Actualiza configuraci√≥n
        - `reiniciar` / `restart` / `reboot` - Reinicia servicios
        
      requestBody:
        required: false
        description: |
          **Payload ultra-flexible** - El sistema acepta cualquier combinaci√≥n de campos:
          
          ### Formatos M√≠nimos V√°lidos:
          ```json
          {}
          {"accion": "detectar"}
          {"action": "deploy", "tag": "v1.2.3"}
          {"comando": "rollback", "tag_anterior": "v1.2.2"}
          ```
          
          ### Formato Completo:
          ```json
          {
            "accion": "desplegar",
            "tag": "v1.2.3",
            "plataforma": "foundry",
            "agente": "Deploy_Agent",
            "configuracion": {...},
            "forzar": false,
            "timeout": 300
          }
          ```
          
        content:
          application/json:
            schema:
              type: object
              properties:
                # Campos de acci√≥n (m√∫ltiples sin√≥nimos)
                accion:
                  type: string
                  enum: ["detectar", "preparar", "desplegar", "rollback", "estado", "actualizar", "reiniciar"]
                  description: "Acci√≥n principal a ejecutar"
                action:
                  type: string
                  description: "Sin√≥nimo de 'accion' (ingl√©s)"
                comando:
                  type: string
                  description: "Sin√≥nimo de 'accion'"
                command:
                  type: string
                  description: "Sin√≥nimo de 'accion'"
                operacion:
                  type: string
                  description: "Sin√≥nimo de 'accion'"
                operation:
                  type: string
                  description: "Sin√≥nimo de 'accion'"
                tipo:
                  type: string
                  description: "Sin√≥nimo de 'accion'"
                type:
                  type: string
                  description: "Sin√≥nimo de 'accion'"
                
                # Campos de versi√≥n (m√∫ltiples sin√≥nimos)
                tag:
                  type: string
                  description: "Versi√≥n/tag a desplegar"
                  example: "v1.2.3"
                version:
                  type: string
                  description: "Sin√≥nimo de 'tag'"
                v:
                  type: string
                  description: "Sin√≥nimo corto de 'tag'"
                
                # Campos de rollback
                tag_anterior:
                  type: string
                  description: "Versi√≥n anterior para rollback"
                  example: "v1.2.2"
                previous_version:
                  type: string
                  description: "Sin√≥nimo de 'tag_anterior'"
                prev:
                  type: string
                  description: "Sin√≥nimo corto de 'tag_anterior'"
                
                # Campos de contexto
                plataforma:
                  type: string
                  enum: ["foundry", "codegpt", "cli", "general"]
                  description: "Plataforma que invoca el endpoint"
                platform:
                  type: string
                  description: "Sin√≥nimo de 'plataforma'"
                target:
                  type: string
                  description: "Sin√≥nimo de 'plataforma'"
                
                agente:
                  type: string
                  description: "Nombre del agente que invoca"
                  example: "Deploy_Agent"
                agent:
                  type: string
                  description: "Sin√≥nimo de 'agente'"
                client:
                  type: string
                  description: "Sin√≥nimo de 'agente'"
                
                # Configuraci√≥n
                configuracion:
                  type: object
                  description: "Configuraci√≥n espec√≠fica del agente"
                  additionalProperties: true
                config:
                  type: object
                  description: "Sin√≥nimo de 'configuracion'"
                settings:
                  type: object
                  description: "Sin√≥nimo de 'configuracion'"
                
                # Opciones de ejecuci√≥n
                forzar:
                  type: boolean
                  default: false
                  description: "Forzar ejecuci√≥n sin validaciones"
                force:
                  type: boolean
                  description: "Sin√≥nimo de 'forzar'"
                f:
                  type: boolean
                  description: "Sin√≥nimo corto de 'forzar'"
                
                timeout:
                  type: integer
                  default: 300
                  description: "Timeout en segundos"
                timeout_s:
                  type: integer
                  description: "Sin√≥nimo de 'timeout'"
                
              additionalProperties: true
              description: |
                **IMPORTANTE:** Este schema es indicativo. El endpoint acepta cualquier combinaci√≥n
                de campos y se adapta din√°micamente. No hay campos obligatorios.
                
            examples:
              payload_minimo:
                summary: "Payload m√≠nimo (detecci√≥n autom√°tica)"
                value: {}
              
              detectar_cambios:
                summary: "Detectar cambios"
                value:
                  accion: "detectar"
              
              preparar_despliegue:
                summary: "Preparar script de despliegue"
                value:
                  action: "prepare"
                  tag: "v1.2.3"
              
              desplegar_version:
                summary: "Desplegar versi√≥n espec√≠fica"
                value:
                  accion: "desplegar"
                  tag: "v1.2.3"
                  plataforma: "foundry"
                  agente: "Deploy_Agent"
              
              rollback_version:
                summary: "Rollback a versi√≥n anterior"
                value:
                  comando: "rollback"
                  tag_anterior: "v1.2.2"
              
              actualizar_agente:
                summary: "Actualizar configuraci√≥n de agente"
                value:
                  operacion: "actualizar"
                  agente: "Deploy_Agent"
                  configuracion:
                    modelo: "gpt-4o-mini"
                    temperatura: 0.2
                    herramientas: ["leer-archivo", "ejecutar-cli"]
              
              foundry_format:
                summary: "Formato t√≠pico de Foundry"
                value:
                  action: "deploy"
                  version: "v1.2.3"
                  platform: "foundry"
                  agent: "AzureSupervisor"
              
              codegpt_format:
                summary: "Formato t√≠pico de CodeGPT"
                value:
                  accion: "desplegar"
                  tag: "v1.2.3"
                  plataforma: "codegpt"
                  agente: "Deploy_Agent"
                  configuracion:
                    modelo: "gpt-4o-mini"
                    descripcion: "Agente para tareas DevOps"

      responses:
        '200':
          description: "Operaci√≥n exitosa"
          content:
            application/json:
              schema:
                type: object
                properties:
                  exito:
                    type: boolean
                    example: true
                  accion_ejecutada:
                    type: string
                    example: "desplegar"
                  alias_usado:
                    type: string
                    nullable: true
                    example: "deploy"
                  resultado:
                    type: object
                    description: "Resultado espec√≠fico de la acci√≥n ejecutada"
                    additionalProperties: true
                  metadata:
                    type: object
                    properties:
                      run_id:
                        type: string
                        example: "abc12345"
                      endpoint:
                        type: string
                        example: "/api/gestionar-despliegue"
                      formato_payload:
                        type: string
                        example: "json_estandar"
                      timestamp:
                        type: string
                        format: date-time
                      version_sistema:
                        type: string
                        example: "robusto_v1.0"
                  proximas_acciones:
                    type: array
                    items:
                      type: string
                    example: ["Verificar estado con 'estado'", "Monitorear logs de la aplicaci√≥n"]
              
              examples:
                detectar_exitoso:
                  summary: "Detecci√≥n exitosa"
                  value:
                    exito: true
                    accion_ejecutada: "detectar"
                    alias_usado: null
                    resultado:
                      accion: "detectar"
                      archivo_verificado: "/home/site/wwwroot/function_app.py"
                      hash_funcion: "a1b2c3d4"
                      herramientas_disponibles:
                        az_cli: true
                        docker: true
                        git: true
                      mensaje: "Detecci√≥n completada. Hash: a1b2c3d4"
                    metadata:
                      run_id: "abc12345"
                      endpoint: "/api/gestionar-despliegue"
                      formato_payload: "json_estandar"
                      timestamp: "2024-01-15T10:30:00Z"
                      version_sistema: "robusto_v1.0"
                    proximas_acciones:
                      - "preparar - para generar script de despliegue"
                      - "estado - para verificar estado actual"
                
                desplegar_exitoso:
                  summary: "Despliegue exitoso"
                  value:
                    exito: true
                    accion_ejecutada: "desplegar"
                    alias_usado: "deploy"
                    resultado:
                      accion: "desplegar"
                      tag: "v1.2.3"
                      comandos_planificados:
                        - "docker build -t copiloto-func-azcli:v1.2.3 ."
                        - "docker tag copiloto-func-azcli:v1.2.3 boatrentalacr.azurecr.io/copiloto-func-azcli:v1.2.3"
                        - "az acr login -n boatrentalacr"
                        - "docker push boatrentalacr.azurecr.io/copiloto-func-azcli:v1.2.3"
                      mensaje: "Despliegue de v1.2.3 planificado exitosamente"
                    metadata:
                      run_id: "def67890"
                      endpoint: "/api/gestionar-despliegue"
                      formato_payload: "json_estandar"
                      timestamp: "2024-01-15T10:35:00Z"
                      version_sistema: "robusto_v1.0"

        '400':
          description: "Error de validaci√≥n (con sugerencias para correcci√≥n)"
          content:
            application/json:
              schema:
                type: object
                properties:
                  exito:
                    type: boolean
                    example: false
                  error_code:
                    type: string
                    example: "VALIDATION_ERROR"
                  error:
                    type: string
                    example: "Validaci√≥n fallida: Rollback requiere especificar tag_anterior"
                  sugerencias:
                    type: array
                    items:
                      type: string
                    example:
                      - "Agregar par√°metro 'tag_anterior' para rollback"
                      - "Ejemplo: {'accion': 'rollback', 'tag_anterior': 'v1.2.2'}"
                  detalles:
                    type: object
                    additionalProperties: true
                  metadata:
                    type: object
                    properties:
                      run_id:
                        type: string
                      endpoint:
                        type: string
                      timestamp:
                        type: string
                        format: date-time
                      status_code:
                        type: integer
                        example: 400
                  agent_guidance:
                    type: object
                    properties:
                      next_action:
                        type: string
                        example: "retry_with_corrections"
                      retry_suggestions:
                        type: array
                        items:
                          type: string
                      format_example:
                        type: object
                        additionalProperties: true
              
              examples:
                rollback_sin_tag:
                  summary: "Error: Rollback sin tag anterior"
                  value:
                    exito: false
                    error_code: "VALIDATION_ERROR"
                    error: "Validaci√≥n fallida: Rollback requiere especificar tag_anterior"
                    sugerencias:
                      - "Agregar par√°metro 'tag_anterior' para rollback"
                      - "Ejemplo: {'accion': 'rollback', 'tag_anterior': 'v1.2.2'}"
                    detalles:
                      accion: "rollback"
                      parametros_recibidos: []
                      acciones_validas: ["detectar", "preparar", "desplegar", "rollback", "estado", "actualizar", "reiniciar"]
                    metadata:
                      run_id: "ghi12345"
                      endpoint: "/api/gestionar-despliegue"
                      timestamp: "2024-01-15T10:40:00Z"
                      status_code: 400
                    agent_guidance:
                      next_action: "retry_with_corrections"
                      retry_suggestions:
                        - "Agregar par√°metro 'tag_anterior' para rollback"
                        - "Ejemplo: {'accion': 'rollback', 'tag_anterior': 'v1.2.2'}"
                      format_example:
                        accion: "rollback"
                        tag_anterior: "v1.2.2"

        '401':
          description: "Error de autenticaci√≥n"
          content:
            application/json:
              schema:
                type: object
                properties:
                  exito:
                    type: boolean
                    example: false
                  error_code:
                    type: string
                    example: "AUTHENTICATION_ERROR"
                  error:
                    type: string
                    example: "No se pudo autenticar con Azure"
                  sugerencias:
                    type: array
                    items:
                      type: string
                    example:
                      - "En Azure: habilitar Managed Identity"
                      - "En local: ejecutar 'az login'"
                      - "Verificar Service Principal si est√° configurado"

        '500':
          description: "Error cr√≠tico del sistema"
          content:
            application/json:
              schema:
                type: object
                properties:
                  exito:
                    type: boolean
                    example: false
                  error_code:
                    type: string
                    example: "CRITICAL_SYSTEM_ERROR"
                  error:
                    type: string
                    example: "Error cr√≠tico del sistema: Connection timeout"
                  sugerencias:
                    type: array
                    items:
                      type: string
                    example:
                      - "Verificar logs del sistema"
                      - "Reintentar con payload simplificado"
                      - "Contactar soporte si el error persiste"

components:
  schemas:
    AccionDespliegue:
      type: string
      enum:
        - "detectar"
        - "preparar" 
        - "desplegar"
        - "rollback"
        - "estado"
        - "actualizar"
        - "reiniciar"
      description: "Acciones principales soportadas"
    
    AliasAccion:
      type: string
      enum:
        - "detect"
        - "check"
        - "prepare"
        - "build"
        - "validate"
        - "deploy"
        - "revert"
        - "status"
        - "info"
        - "update"
        - "upgrade"
        - "restart"
        - "reboot"
      description: "Alias y sin√≥nimos de acciones"
    
    PlataformaAgente:
      type: string
      enum:
        - "foundry"
        - "codegpt"
        - "cli"
        - "general"
      description: "Plataformas de agentes soportadas"

  examples:
    PayloadVacio:
      summary: "Payload vac√≠o (usa detecci√≥n autom√°tica)"
      value: {}
    
    DetectarCambios:
      summary: "Detectar cambios en el sistema"
      value:
        accion: "detectar"
    
    PrepararDespliegue:
      summary: "Preparar script de despliegue"
      value:
        action: "prepare"
        version: "v1.2.3"
    
    DesplegarFoundry:
      summary: "Desplegar desde Foundry"
      value:
        action: "deploy"
        version: "v1.2.3"
        platform: "foundry"
        agent: "AzureSupervisor"
    
    DesplegarCodeGPT:
      summary: "Desplegar desde CodeGPT"
      value:
        accion: "desplegar"
        tag: "v1.2.3"
        plataforma: "codegpt"
        agente: "Deploy_Agent"
        configuracion:
          modelo: "gpt-4o-mini"
          temperatura: 0.2
    
    RollbackVersion:
      summary: "Rollback a versi√≥n anterior"
      value:
        comando: "rollback"
        tag_anterior: "v1.2.2"
    
    ActualizarAgente:
      summary: "Actualizar configuraci√≥n de agente"
      value:
        operacion: "actualizar"
        agente: "Deploy_Agent"
        configuracion:
          modelo: "gpt-4o-mini"
          temperatura: 0.35
          agregar_herramientas: ["diagnostico-recursos"]
          remover_herramientas: ["bateria-endpoints"]

tags:
  - name: "Despliegue Robusto"
    description: "Sistema robusto y sem√°ntico para gesti√≥n de despliegues"
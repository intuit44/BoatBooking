{
  "openapi": "3.0.3",
  "info": {
    "title": "Copiloto Function Gateway",
    "version": "2.1",
    "description": "Herramienta directa a la Function App (sin Logic App / SAS)"
  },
  "servers": [
    {
      "url": "https://copiloto-semantico-func-us2.azurewebsites.net"
    }
  ],
  "paths": {
    "/api/crear-contenedor": {
      "post": {
        "summary": "Crear contenedor en Blob Storage",
        "operationId": "crearContenedor",
        "tags": [
          "Azure Storage"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "nombre"
                ],
                "properties": {
                  "nombre": {
                    "type": "string",
                    "pattern": "^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$",
                    "description": "3–63 chars, minúsculas y guiones, no empezar/terminar en guion"
                  },
                  "publico": {
                    "type": "boolean",
                    "default": false,
                    "description": "Si el contenedor será de acceso público"
                  },
                  "metadata": {
                    "type": "object",
                    "description": "Metadata adicional del contenedor"
                  }
                }
              },
              "examples": {
                "basico": {
                  "value": {
                    "nombre": "mi-contenedor"
                  }
                },
                "completo": {
                  "value": {
                    "nombre": "backup-2024",
                    "publico": false,
                    "metadata": {
                      "proyecto": "boat-rental",
                      "tipo": "backup"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Contenedor creado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "mensaje": {
                      "type": "string"
                    },
                    "contenedor": {
                      "type": "string"
                    },
                    "url": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Nombre inválido o parámetros incorrectos"
          },
          "409": {
            "description": "El contenedor ya existe"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
     },
      "/api/invocar": {
        "post": {
        "summary": "Proxy para otros endpoints",
        "operationId": "invocar",
        "tags": [
          "Proxy"
        ],
        "requestBody": {
          "required": true,
          "content": {
          "application/json": {
            "schema": {
            "type": "object",
            "required": [
              "endpoint",
              "method"
            ],
            "properties": {
              "endpoint": {
              "type": "string",
              "description": "Nombre del endpoint (sin /api/)",
              "examples": ["ejecutar-cli", "status", "health"]
              },
              "method": {
              "type": "string",
              "enum": ["GET", "POST"],
              "description": "Método HTTP"
              },
              "data": {
              "type": "object",
              "description": "Datos para el endpoint destino",
              "additionalProperties": true
              }
            }
            },
            "examples": {
            "ejecutar_cli": {
              "value": {
              "endpoint": "ejecutar-cli",
              "method": "POST",
              "data": {
                "comando": "account show"
              }
              }
            },
            "status": {
              "value": {
              "endpoint": "status",
              "method": "GET"
              }
            }
            }
          }
          }
        },
        "responses": {
          "200": {
          "description": "Respuesta del endpoint destino",
          "content": {
            "application/json": {
            "schema": {
              "type": "object",
              "additionalProperties": true
            }
            }
          }
          },
          "400": {
          "description": "Endpoint no válido o parámetros incorrectos"
          },
          "500": {
          "description": "Error en el endpoint destino"
          }
        }
        }
       },    "/api/ejecutar-cli": {
        "post": {
        "summary": "Ejecuta comandos de Azure CLI",
        "operationId": "ejecutarCLI",
        "tags": [
          "Azure CLI"
        ],
        "x-tool-definition": {
          "name": "ejecutar_cli",
          "description": "Ejecuta comandos de Azure CLI",
          "parameters": {
          "type": "object",
          "properties": {
            "comando": {
            "type": "string",
            "description": "El comando Azure CLI a ejecutar (sin 'az' al inicio)"
            }
          },
          "required": ["comando"]
          },
          "endpoint": "https://copiloto-semantico-func-us2.azurewebsites.net/api/ejecutar-cli",
          "method": "POST"
        },
        "requestBody": {
          "required": true,
          "content": {
          "application/json": {
            "schema": {
            "type": "object",
            "required": [
              "comando"
            ],
            "properties": {
              "comando": {
              "type": "string",
              "description": "El comando Azure CLI a ejecutar (sin 'az' al inicio)"
              }
            }
            },
            "examples": {
            "storage_list": {
              "value": {
              "comando": "storage account list"
              }
            },
            "functionapp_show": {
              "value": {
              "comando": "functionapp show --name copiloto-semantico-func --resource-group boat-rental-app-group"
              }
            }
            }
          }
          }
        },
        "responses": {
          "200": {
          "description": "Comando ejecutado",
          "content": {
            "application/json": {
            "schema": {
              "type": "object",
              "properties": {
              "exito": {
                "type": "boolean"
              },
              "comando_ejecutado": {
                "type": "string"
              },
              "output": {
                "oneOf": [
                {
                  "type": "object"
                },
                {
                  "type": "array"
                },
                {
                  "type": "string"
                }
                ]
              },
              "error": {
                "type": "string"
              },
              "codigo_salida": {
                "type": "integer"
              }
              }
            }
            }
          }
          },
          "403": {
          "description": "Operación no permitida o requiere confirmación"
          },
          "408": {
          "description": "Timeout excedido"
          }
        }
        }
      },

    "/api/diagnostico-recursos": {
      "get": {
        "summary": "Diagnóstico completo de recursos Azure",
        "operationId": "diagnosticoRecursos",
        "tags": [
          "Diagnóstico"
        ],
        "parameters": [
          {
            "name": "metricas",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": true
            },
            "description": "Incluir métricas de rendimiento"
          },
          {
            "name": "costos",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": false
            },
            "description": "Incluir análisis de costos"
          },
          {
            "name": "recurso",
            "in": "query",
            "schema": {
              "type": "string"
            },
            "description": "Recurso específico a diagnosticar"
          }
        ],
        "responses": {
          "200": {
            "description": "Diagnóstico completo",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "timestamp": {
                      "type": "string"
                    },
                    "ambiente": {
                      "type": "string"
                    },
                    "recursos": {
                      "type": "object",
                      "properties": {
                        "function_app": {
                          "type": "object"
                        },
                        "storage_account": {
                          "type": "object"
                        },
                        "storage_stats": {
                          "type": "object"
                        }
                      }
                    },
                    "metricas": {
                      "type": "object"
                    },
                    "alertas": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "nivel": {
                            "type": "string"
                          },
                          "mensaje": {
                            "type": "string"
                          },
                          "accion": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "recomendaciones": {
                      "type": "array"
                    },
                    "sistema": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "post": {
        "summary": "Diagnóstico con parámetros específicos",
        "operationId": "diagnosticoRecursosPost",
        "tags": [
          "Diagnóstico"
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "metricas": {
                    "type": "boolean"
                  },
                  "costos": {
                    "type": "boolean"
                  },
                  "recurso": {
                    "type": "string"
                  },
                  "profundidad": {
                    "type": "string",
                    "enum": [
                      "basico",
                      "detallado",
                      "completo"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Diagnóstico ejecutado"
          }
        }
      }
    },
    "/api/hybrid": {
      "post": {
        "summary": "Router semántico (intenciones)",
        "operationId": "hybrid",
        "parameters": [
          {
            "name": "semantic_response",
            "in": "query",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": false
            },
            "description": "Si es true, la respuesta será texto semántico. Si se envían ambos (query y body), prevalece el parámetro de query"
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "agent_response": {
                    "type": "string"
                  },
                  "payload": {
                    "type": "object"
                  },
                  "semantic_response": {
                    "type": "boolean",
                    "default": false,
                    "description": "Si es true, la respuesta será texto semántico. El parámetro de query tiene precedencia"
                  }
                },
                "required": [
                  "agent_response"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {},
              "text/plain": {}
            }
          },
          "400": {
            "description": "Solicitud inválida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorEnvelope"
                }
              }
            }
          },
          "500": {
            "description": "Error servidor",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorEnvelope"
                }
              }
            }
          }
        }
      }
    },
    "/api/status": {
      "get": {
        "summary": "Estado detallado (ambiente y storage)",
        "operationId": "statusDetallado",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "copiloto": {
                      "type": "string"
                    },
                    "version": {
                      "type": "string"
                    },
                    "timestamp": {
                      "type": "string"
                    },
                    "ambiente": {
                      "type": "string"
                    },
                    "storage": {
                      "type": "string"
                    },
                    "is_azure": {
                      "type": "boolean"
                    },
                    "container": {
                      "type": "string"
                    },
                    "blob_ready": {
                      "type": "boolean"
                    },
                    "endpoints": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "ready": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/copiloto": {
      "get": {
        "summary": "Endpoint principal del copiloto",
        "operationId": "copiloto",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          }
        }
      }
    },
    "/api/listar-blobs": {
      "get": {
        "summary": "Listar blobs",
        "operationId": "listarBlobs",
        "parameters": [
          {
            "name": "prefix",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "top",
            "in": "query",
            "required": false,
            "schema": {
              "type": "integer",
              "default": 10
            }
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          }
        }
      }
    },
    "/api/escribir-archivo": {
      "post": {
        "summary": "Crear/guardar un archivo",
        "operationId": "escribirArchivo",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "ruta",
                  "contenido"
                ],
                "properties": {
                  "ruta": {
                    "type": "string",
                    "example": "docs/PRUEBA.md"
                  },
                  "contenido": {
                    "type": "string",
                    "example": "# Hola\nEsto es una prueba."
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Creado"
          },
          "400": {
            "description": "Error de validación"
          }
        }
      }
    },
    "/api/modificar-archivo": {
      "post": {
        "summary": "Modificar un archivo existente",
        "operationId": "modificarArchivo",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "ruta",
                  "operacion"
                ],
                "properties": {
                  "ruta": {
                    "type": "string",
                    "example": "docs/PRUEBA.md"
                  },
                  "operacion": {
                    "type": "string",
                    "enum": [
                      "agregar_linea",
                      "reemplazar_linea",
                      "eliminar_linea",
                      "buscar_reemplazar",
                      "agregar_inicio",
                      "agregar_final",
                      "insertar_antes",
                      "insertar_despues"
                    ]
                  },
                  "linea": {
                    "type": "integer",
                    "description": "Usado por insertar_* y reemplazar/eliminar_linea"
                  },
                  "contenido": {
                    "description": "Para 'buscar_reemplazar': acepta objeto {buscar,reemplazar} o string 'OLD->NEW' | 'OLD|NEW'. Para otras operaciones: string libre.",
                    "oneOf": [
                      {
                        "type": "object",
                        "required": [
                          "buscar",
                          "reemplazar"
                        ],
                        "properties": {
                          "buscar": {
                            "type": "string"
                          },
                          "reemplazar": {
                            "type": "string"
                          }
                        }
                      },
                      {
                        "type": "string",
                        "minLength": 1,
                        "description": "Formato 'OLD->NEW' o 'OLD|NEW'",
                        "pattern": ".+(->|\\|).+"
                      },
                      {
                        "type": "string"
                      }
                    ]
                  },
                  "buscar": {
                    "type": "string",
                    "description": "Alternativa: claves al tope del body"
                  },
                  "reemplazar": {
                    "type": "string",
                    "description": "Alternativa: claves al tope del body"
                  }
                },
                "anyOf": [
                  {
                    "required": [
                      "contenido"
                    ]
                  },
                  {
                    "required": [
                      "buscar",
                      "reemplazar"
                    ]
                  }
                ]
              },
              "examples": {
                "objeto_buscar_reemplazar": {
                  "summary": "Objeto {buscar,reemplazar}",
                  "value": {
                    "ruta": "docs/PRUEBA.md",
                    "operacion": "buscar_reemplazar",
                    "contenido": {
                      "buscar": "OK",
                      "reemplazar": "OK ✅"
                    }
                  }
                },
                "string_arrow": {
                  "summary": "String 'OLD->NEW'",
                  "value": {
                    "ruta": "docs/PRUEBA.md",
                    "operacion": "buscar_reemplazar",
                    "contenido": "OK->OK ✅"
                  }
                },
                "top_level_keys": {
                  "summary": "Claves al tope del body",
                  "value": {
                    "ruta": "docs/PRUEBA.md",
                    "operacion": "buscar_reemplazar",
                    "buscar": "OK",
                    "reemplazar": "OK ✅"
                  }
                },
                "agregar_final": {
                  "summary": "Operación no-BR con string libre",
                  "value": {
                    "ruta": "docs/PRUEBA.md",
                    "operacion": "agregar_final",
                    "contenido": "Nueva línea"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK"
          },
          "400": {
            "description": "Error de validación (p. ej., payload inválido)"
          },
          "404": {
            "description": "No encontrado (archivo inexistente)"
          }
        }
      }
    },
    "/api/leer-archivo": {
      "get": {
        "summary": "Leer un archivo",
        "operationId": "leerArchivo",
        "parameters": [
          {
            "in": "query",
            "name": "ruta",
            "schema": {
              "type": "string"
            },
            "required": true
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          },
          "404": {
            "description": "No encontrado"
          }
        }
      }
    },
    "/api/eliminar-archivo": {
      "post": {
        "summary": "Eliminar archivo (Blob o local)",
        "operationId": "eliminarArchivo",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "ruta": {
                    "type": "string"
                  }
                },
                "required": [
                  "ruta"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Eliminado",
            "content": {
              "application/json": {}
            }
          },
          "404": {
            "description": "No encontrado"
          }
        }
      },
      "delete": {
        "summary": "Eliminar archivo (por query)",
        "operationId": "eliminarArchivoDelete",
        "parameters": [
          {
            "name": "ruta",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Eliminado",
            "content": {
              "application/json": {}
            }
          },
          "404": {
            "description": "No encontrado"
          }
        }
      }
    },
    "/api/ejecutar-script": {
      "post": {
        "summary": "Ejecutar script desde /scripts (.py/.sh/.ps1)",
        "operationId": "ejecutarScript",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "script": {
                    "type": "string",
                    "example": "scripts/hello2.py"
                  },
                  "args": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "timeout_s": {
                    "type": "integer",
                    "default": 60
                  },
                  "sync_outputs": {
                    "type": "boolean",
                    "default": true
                  },
                  "parametros": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Alias de 'args' por compatibilidad"
                  }
                },
                "required": [
                  "script"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          },
          "500": {
            "description": "Error ejecución"
          }
        }
      }
    },
    "/api/ejecutar": {
      "post": {
        "summary": "Orquestador de intenciones",
        "operationId": "ejecutar",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "intencion": {
                    "type": "string",
                    "example": "crear:archivo"
                  },
                  "parametros": {
                    "type": "object"
                  },
                  "contexto": {
                    "type": "object"
                  },
                  "modo": {
                    "type": "string",
                    "default": "normal"
                  }
                },
                "required": [
                  "intencion"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          }
        }
      }
    },
    "/api/health": {
      "get": {
        "summary": "Health check",
        "operationId": "health",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          }
        }
      }
    },
    "/api/mover-archivo": {
      "post": {
        "summary": "Mover/Renombrar archivo",
        "operationId": "moverArchivo",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "origen",
                  "destino"
                ],
                "properties": {
                  "origen": {
                    "type": "string",
                    "example": "docs/PRUEBA.md"
                  },
                  "destino": {
                    "type": "string",
                    "example": "docs/historico/PRUEBA.md"
                  },
                  "overwrite": {
                    "type": "boolean",
                    "default": false
                  },
                  "eliminar_origen": {
                    "type": "boolean",
                    "default": true
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          },
          "400": {
            "description": "Error"
          }
        }
      }
    },
    "/api/info-archivo": {
      "get": {
        "summary": "Obtiene metadatos de un archivo",
        "operationId": "infoArchivo",
        "parameters": [
          {
            "in": "query",
            "name": "ruta",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "OK"
          },
          "404": {
            "description": "No encontrado"
          }
        }
      }
    },
    "/api/descargar-archivo": {
      "get": {
        "summary": "Descarga archivo como texto/base64 en JSON",
        "operationId": "descargarArchivo",
        "parameters": [
          {
            "in": "query",
            "name": "ruta",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "in": "query",
            "name": "modo",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "inline",
                "base64"
              ],
              "default": "inline"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "OK"
          },
          "404": {
            "description": "No encontrado"
          }
        }
      }
    },
    "/api/copiar-archivo": {
      "post": {
        "summary": "Copia un archivo (Blob o local)",
        "operationId": "copiarArchivo",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "origen",
                  "destino"
                ],
                "properties": {
                  "origen": {
                    "type": "string"
                  },
                  "destino": {
                    "type": "string"
                  },
                  "overwrite": {
                    "type": "boolean",
                    "default": false
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          },
          "400": {
            "description": "Error"
          }
        }
      }
    },
    "/api/preparar-script": {
      "post": {
        "summary": "Trae un script desde Blob a /scripts local",
        "operationId": "prepararScript",
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "ruta"
                ],
                "properties": {
                  "ruta": {
                    "type": "string",
                    "example": "scripts/hello.py"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {}
            }
          },
          "400": {
            "description": "Error"
          }
        }
      }
    },
    "/api/deploy": {
      "post": {
        "summary": "Desplegar recursos Azure usando ARM templates",
        "operationId": "deployARM",
        "tags": [
          "Azure Deployment"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "resourceGroup": {
                    "type": "string",
                    "description": "Nombre del resource group"
                  },
                  "location": {
                    "type": "string",
                    "default": "eastus",
                    "description": "Ubicación de Azure"
                  },
                  "template": {
                    "type": "object",
                    "description": "ARM template JSON"
                  },
                  "templateUri": {
                    "type": "string",
                    "description": "URI del ARM template"
                  },
                  "parameters": {
                    "type": "object",
                    "description": "Parámetros del template"
                  },
                  "validate_only": {
                    "type": "boolean",
                    "default": false,
                    "description": "Si es true, valida sin desplegar"
                  }
                },
                "oneOf": [
                  {
                    "required": [
                      "resourceGroup",
                      "template"
                    ]
                  },
                  {
                    "required": [
                      "resourceGroup",
                      "templateUri"
                    ]
                  }
                ]
              },
              "examples": {
                "empty_deployment": {
                  "summary": "Deployment vacío de prueba",
                  "value": {
                    "resourceGroup": "boat-rental-app-group",
                    "location": "eastus",
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "parameters": {},
                      "variables": {},
                      "resources": []
                    }
                  }
                },
                "storage_account": {
                  "summary": "Crear Storage Account",
                  "value": {
                    "resourceGroup": "boat-rental-app-group",
                    "location": "eastus",
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "parameters": {},
                      "variables": {
                        "storageAccountName": "[concat('test', uniqueString(resourceGroup().id))]"
                      },
                      "resources": [
                        {
                          "type": "Microsoft.Storage/storageAccounts",
                          "apiVersion": "2021-04-01",
                          "name": "[variables('storageAccountName')]",
                          "location": "[resourceGroup().location]",
                          "sku": {
                            "name": "Standard_LRS"
                          },
                          "kind": "StorageV2"
                        }
                      ]
                    }
                  }
                },
                "validate_deployment": {
                  "summary": "Validar template sin desplegar",
                  "value": {
                    "resourceGroup": "boat-rental-app-group",
                    "location": "eastus",
                    "validate_only": true,
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "parameters": {},
                      "variables": {},
                      "resources": []
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Deployment iniciado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ok": {
                      "type": "boolean"
                    },
                    "deploymentName": {
                      "type": "string"
                    },
                    "resourceGroup": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "state": {
                      "type": "string"
                    },
                    "mode": {
                      "type": "string"
                    },
                    "hasTemplate": {
                      "type": "boolean"
                    },
                    "hasTemplateUri": {
                      "type": "boolean"
                    },
                    "parameters_keys": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Parámetros faltantes",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorEnvelope"
                }
              }
            }
          },
          "500": {
            "description": "Error en deployment",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorEnvelope"
                }
              }
            }
          }
        }
      }
    },
    "/api/configurar-cors": {
      "post": {
        "summary": "Configurar CORS para Function App",
        "operationId": "configurarCORS",
        "tags": [
          "Azure Configuration"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "allowed_origins"
                ],
                "properties": {
                  "function_app": {
                    "type": "string",
                    "description": "Nombre de la Function App (opcional, usa env var si no se proporciona)"
                  },
                  "resource_group": {
                    "type": "string",
                    "description": "Resource group (opcional, usa env var si no se proporciona)"
                  },
                  "allowed_origins": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "default": [
                      "*"
                    ],
                    "description": "Lista de orígenes permitidos"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "CORS configurado",
            "content": {
              "application/json": {}
            }
          },
          "500": {
            "description": "Error configurando CORS"
          }
        }
      }
    },
    "/api/configurar-app-settings": {
      "post": {
        "summary": "Configurar App Settings de Function App",
        "operationId": "configurarAppSettings",
        "tags": [
          "Azure Configuration"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "settings"
                ],
                "properties": {
                  "function_app": {
                    "type": "string"
                  },
                  "resource_group": {
                    "type": "string"
                  },
                  "settings": {
                    "type": "object",
                    "additionalProperties": true,
                    "description": "Key-value pairs de configuración"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Settings actualizados"
          },
          "400": {
            "description": "Parámetros faltantes"
          }
        }
      }
    },
    "/api/escalar-plan": {
      "post": {
        "summary": "Escalar App Service Plan",
        "operationId": "escalarPlan",
        "tags": [
          "Azure Configuration"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "plan_name"
                ],
                "properties": {
                  "plan_name": {
                    "type": "string"
                  },
                  "resource_group": {
                    "type": "string"
                  },
                  "sku": {
                    "type": "string",
                    "default": "EP1",
                    "enum": [
                      "B1",
                      "B2",
                      "B3",
                      "S1",
                      "S2",
                      "S3",
                      "P1V2",
                      "P2V2",
                      "P3V2",
                      "EP1",
                      "EP2",
                      "EP3"
                    ],
                    "description": "SKU del plan"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Plan escalado"
          },
          "400": {
            "description": "Parámetros faltantes"
          }
        }
      }
    },
    "/api/auditar-deploy": {
      "get": {
        "summary": "Auditar deployment actual de la Function App",
        "operationId": "auditarDeploy",
        "tags": [
          "Diagnóstico"
        ],
        "responses": {
          "200": {
            "description": "Auditoría completa del deployment",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ok": {
                      "type": "boolean"
                    },
                    "details": {
                      "type": "object",
                      "properties": {
                        "files_count": {
                          "type": "integer"
                        },
                        "function_app_py_sha256": {
                          "type": ["string", "null"]
                        },
                        "baseline_sha256": {
                          "type": ["string", "null"]
                        },
                        "match_baseline": {
                          "type": ["boolean", "null"]
                        },
                        "top_files": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "path": {
                                "type": "string"
                              },
                              "size": {
                                "type": "integer"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/bateria-endpoints": {
      "post": {
        "summary": "Ejecutar batería de pruebas de endpoints",
        "operationId": "bateriaEndpoints",
        "tags": [
          "Testing"
        ],
        "responses": {
          "200": {
            "description": "Batería ejecutada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "summary": {
                      "type": "object",
                      "properties": {
                        "total": {
                          "type": "integer"
                        },
                        "ok": {
                          "type": "integer"
                        },
                        "fail": {
                          "type": "integer"
                        }
                      }
                    },
                    "results": {
                      "type": "array"
                    }
                  }
                }
              }
            }
          }
        }
      },
      "get": {
        "summary": "Ejecutar batería de pruebas (GET)",
        "operationId": "bateriaEndpointsGet",
        "tags": [
          "Testing"
        ],
        "responses": {
          "200": {
            "description": "Batería ejecutada"
          }
        }
      }
    },
    "/api/probar-endpoint": {
      "post": {
        "summary": "Probar un endpoint específico",
        "operationId": "probarEndpoint",
        "tags": [
          "Testing"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "endpoint"
                ],
                "properties": {
                  "endpoint": {
                    "type": "string",
                    "description": "Endpoint a probar (ej: /api/status)"
                  },
                  "method": {
                    "type": "string",
                    "default": "GET",
                    "enum": [
                      "GET",
                      "POST",
                      "DELETE"
                    ]
                  },
                  "params": {
                    "type": "object"
                  },
                  "data": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Endpoint probado",
            "content": {
              "application/json": {}
            }
          },
          "400": {
            "description": "Endpoint no reconocido"
          }
        }
      },
      "get": {
        "summary": "Probar endpoint vía GET",
        "operationId": "probarEndpointGet",
        "tags": [
          "Testing"
        ],
        "parameters": [
          {
            "name": "endpoint",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "method",
            "in": "query",
            "schema": {
              "type": "string",
              "default": "GET"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Endpoint probado"
          }
        }
      }
    },

    "/api/diagnostico-configurar": {
      "post": {
        "summary": "Configurar diagnósticos Azure Monitor",
        "operationId": "configurarDiagnosticos",
        "tags": [
          "Diagnóstico"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "resourceId",
                  "workspaceId"
                ],
                "properties": {
                  "resourceId": {
                    "type": "string"
                  },
                  "workspaceId": {
                    "type": "string"
                  },
                  "settingName": {
                    "type": "string",
                    "default": "fa-logs"
                  },
                  "logs": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  },
                  "metrics": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Diagnósticos configurados"
          }
        }
      }
    },
    "/api/diagnostico-listar": {
      "get": {
        "summary": "Listar configuraciones de diagnóstico",
        "operationId": "listarDiagnosticos",
        "tags": [
          "Diagnóstico"
        ],
        "parameters": [
          {
            "name": "resourceId",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de configuraciones"
          }
        }
      }
    },
    "/api/diagnostico-eliminar": {
      "post": {
        "summary": "Eliminar configuración de diagnóstico",
        "operationId": "eliminarDiagnostico",
        "tags": [
          "Diagnóstico"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "resourceId",
                  "settingName"
                ],
                "properties": {
                  "resourceId": {
                    "type": "string"
                  },
                  "settingName": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Configuración eliminada"
          }
        }
      },
      "delete": {
        "summary": "Eliminar configuración vía DELETE",
        "operationId": "eliminarDiagnosticoDelete",
        "tags": [
          "Diagnóstico"
        ],
        "parameters": [
          {
            "name": "resourceId",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "settingName",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Configuración eliminada"
          }
        }
      }
    },
    "/api/render-error": {
      "post": {
        "summary": "Renderizar error semánticamente",
        "operationId": "renderError",
        "tags": [
          "Internal"
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "error"
                ],
                "properties": {
                  "error": {
                    "type": "string"
                  },
                  "context": {
                    "type": "object"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Error renderizado semánticamente",
            "content": {
              "text/plain": {}
            }
          }
        }
      }
    },
    "/api/diagnostico-recursos-completo": {
      "get": {
        "summary": "Diagnóstico completo con SDK Azure",
        "operationId": "diagnosticoRecursosCompleto",
        "tags": [
          "Diagnóstico"
        ],
        "parameters": [
          {
            "name": "metricas",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": true
            }
          },
          {
            "name": "costos",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": false
            }
          },
          {
            "name": "recurso",
            "in": "query",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Diagnóstico completo con SDK"
          }
        }
      },
      "post": {
        "summary": "Diagnóstico completo con parámetros",
        "operationId": "diagnosticoRecursosCompletoPost",
        "tags": [
          "Diagnóstico"
        ],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "metricas": {
                    "type": "boolean"
                  },
                  "costos": {
                    "type": "boolean"
                  },
                  "recurso": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Diagnóstico ejecutado"
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "Azure Storage",
      "description": "Operaciones de Azure Blob Storage"
    },
    {
      "name": "Azure CLI",
      "description": "Ejecución de comandos Azure CLI"
    },
    {
      "name": "Diagnóstico",
      "description": "Diagnóstico y monitoreo de recursos"
    },
    {
      "name": "Azure Deployment",
      "description": "Deployment de recursos con ARM templates"
    },
    {
      "name": "Azure Configuration",
      "description": "Configuración de recursos Azure"
    },
    {
      "name": "Testing",
      "description": "Pruebas y validación de endpoints"
    },
    {
      "name": "Internal",
      "description": "Operaciones internas de la Function App"
    }
  ],
  "components": {
    "schemas": {
      "ErrorEnvelope": {
        "type": "object",
        "properties": {
          "ok": {
            "type": "boolean",
            "const": false
          },
          "error_code": {
            "type": "string"
          },
          "status": {
            "type": ["integer", "null"]
          },
          "cause": {
            "type": "string"
          },
          "hint": {
            "type": ["string", "null"]
          },
          "next_steps": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "trace": {
            "type": ["string", "null"]
          }
        },
        "required": ["ok", "error_code"]
      }
    }
  },
  "x-agent-name": "Architect_BoatRental",
  "x-purpose": "Gestionar estructura backend y API",
  "x-checkpoints": [
    {
      "etapa": "antes_modificar_backend",
      "verificaciones": [
        "leer_archivo_completo",
        "verificar_estructura",
        "verificar_funcion_target",
        "verificar_endpoints_existentes"
      ],
      "requerido_para_continuar": true
    }
  ]
}
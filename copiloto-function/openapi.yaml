{
  "openapi": "3.1.0",
  "info": {
    "title": "Copiloto Function Gateway",
    "version": "3.5",
    "description": "Sistema completo con memoria autom√°tica integrada, queries din√°micas, consulta previa y guardado autom√°tico de interacciones en Cosmos DB. Nota: los endpoints legacy /api/probar-endpoint e /api/invocar fueron retirados; usa /api/copiloto como router sem√°ntico.",
    "license": {
      "name": "MIT",
      "url": "https://opensource.org/licenses/MIT"
    }
  },
  "servers": [
    {
      "url": "https://copiloto-func.ngrok.app"
    },
    {
      "url": "https://copiloto-semantico-func-us2.azurewebsites.net"
    }
  ],
  "paths": {
    "/api/crear-contenedor": {
      "post": {
        "summary": "Crear contenedor en Blob Storage",
        "operationId": "crearContenedor",
        "tags": [
          "Azure Storage"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "nombre"
                ],
                "properties": {
                  "nombre": {
                    "type": "string",
                    "pattern": "^[a-z0-9][a-z0-9-]{1,61}[a-z0-9]$",
                    "description": "3‚Äì63 chars, min√∫sculas y guiones, no empezar/terminar en guion"
                  },
                  "publico": {
                    "type": "boolean",
                    "default": false,
                    "description": "Si el contenedor ser√° de acceso p√∫blico"
                  },
                  "metadata": {
                    "type": "object",
                    "description": "Metadata adicional del contenedor"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Contenedor creado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "mensaje": {
                      "type": "string"
                    },
                    "contenedor": {
                      "type": "string"
                    },
                    "url": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "409": {
            "description": "El contenedor ya existe"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
    },
    "/api/bridge-cli": {
      "post": {
        "summary": "Endpoint tolerante para agentes problem√°ticos",
        "operationId": "bridgeCli",
        "tags": [
          "Bridge"
        ],
        "security": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Respuesta procesada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        }
      }
    },
    "/api/agent-output": {
      "post": {
        "summary": "Registrar salida aut√≥noma del agente Foundry",
        "description": "Recibe la respuesta final del agente cuando no se invoca otro endpoint y la persiste con el thread real",
        "operationId": "agentOutput",
        "tags": [
          "Memoria"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "thread_id": {
                    "type": "string",
                    "description": "ID de thread en Foundry (alias de session_id)"
                  },
                  "session_id": {
                    "type": "string",
                    "description": "ID de sesi√≥n (si no se usa thread_id)"
                  },
                  "agent_id": {
                    "type": "string"
                  },
                  "texto": {
                    "type": "string",
                    "description": "Texto de salida del agente"
                  },
                  "metadata": {
                    "type": "object"
                  }
                },
                "required": [
                  "texto"
                ],
                "additionalProperties": true
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Salida registrada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "mensaje": {
                      "type": "string"
                    },
                    "session_id": {
                      "type": "string"
                    },
                    "agent_id": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida (falta texto o identificadores)"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
    },
    "/api/diagnostico-recursos": {
      "get": {
        "summary": "üîç CONSULTAR PRIMERO - Configuraci√≥n completa del sistema y recursos Azure",
        "description": "‚≠ê ENDPOINT PRIORITARIO: Consultar ANTES de cualquier operaci√≥n que requiera nombres de recursos, URLs o configuraci√≥n. Devuelve: FUNCTION_APP_NAME, FUNCTION_APP_URL, RESOURCE_GROUP, STORAGE_ACCOUNT, REDIS_HOST, COSMOS_ENDPOINT, y estado completo de todos los recursos Azure. Incluye m√©tricas de Redis (dbsize, hits/misses, memoria), estado de Function App, Storage Account, y recomendaciones. Usar este endpoint para obtener valores din√°micos en lugar de hardcodear nombres. Usa KQL sobre Log Analytics (DefaultWorkspace-380fa841-83f3-42fe-adc4-582a5ebe139b-EUS2 en defaultresourcegroup-eus2) para m?tricas y trazas; requiere identidad con rol Log Analytics Reader en ese workspace.",
        "operationId": "diagnosticoRecursos",
        "x-priority": "critical",
        "x-use-cases": [
          "Obtener FUNCTION_APP_URL para construir comandos curl",
          "Obtener FUNCTION_APP_NAME para operaciones Azure CLI",
          "Obtener RESOURCE_GROUP para cualquier operaci√≥n de recursos",
          "Ver estado de Redis (dbsize, keyspace_hits, memoria)",
          "Verificar configuraci√≥n antes de aplicar cambios",
          "Obtener nombres de Storage Account, Cosmos DB, etc."
        ],
        "tags": [
          "Diagn√≥stico"
        ],
        "security": [],
        "parameters": [
          {
            "name": "metricas",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": true
            }
          },
          {
            "name": "costos",
            "in": "query",
            "schema": {
              "type": "boolean",
              "default": false
            }
          },
          {
            "name": "recurso",
            "in": "query",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Diagn√≥stico completo",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "timestamp": {
                      "type": "string"
                    },
                    "ambiente": {
                      "type": "string"
                    },
                    "recursos": {
                      "type": "object"
                    },
                    "metricas": {
                      "type": "object"
                    },
                    "alertas": {
                      "type": "array"
                    },
                    "recomendaciones": {
                      "type": "array"
                    },
                    "sistema": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        },
        "x-log-analytics": {
          "workspace": "DefaultWorkspace-380fa841-83f3-42fe-adc4-582a5ebe139b-EUS2",
          "resource_group": "defaultresourcegroup-eus2",
          "prerequisitos": [
            "Identidad con rol Log Analytics Reader en el workspace",
            "Application Insights 'copiloto-semantico-func-us2' enviando telemetr?a al workspace"
          ]
        },
        "x-cli-fallback": {
          "descripcion": "Si no se encuentran recursos por SDK, usar /api/ejecutar-cli con Azure CLI.",
          "comandos": [
            "az group list --output json",
            "az group show --name boat-rental-app-group --output json"
          ],
          "cuando_usar": "Cuando diagnostico no devuelve recursos o se requiere validar existence de un resource group espec?fico."
        }
      },
      "post": {
        "summary": "Diagn√≥stico con par√°metros espec√≠ficos",
        "operationId": "diagnosticoRecursosPost",
        "tags": [
          "Diagn√≥stico"
        ],
        "security": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "metricas": {
                    "type": "boolean"
                  },
                  "costos": {
                    "type": "boolean"
                  },
                  "recurso": {
                    "type": "string"
                  },
                  "profundidad": {
                    "type": "string",
                    "enum": [
                      "basico",
                      "detallado",
                      "completo"
                    ]
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Diagn√≥stico ejecutado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        },
        "description": " Usa KQL sobre Log Analytics (DefaultWorkspace-380fa841-83f3-42fe-adc4-582a5ebe139b-EUS2 en defaultresourcegroup-eus2) para m?tricas y trazas; requiere identidad con rol Log Analytics Reader en ese workspace.",
        "x-log-analytics": {
          "workspace": "DefaultWorkspace-380fa841-83f3-42fe-adc4-582a5ebe139b-EUS2",
          "resource_group": "defaultresourcegroup-eus2",
          "prerequisitos": [
            "Identidad con rol Log Analytics Reader en el workspace",
            "Application Insights 'copiloto-semantico-func-us2' enviando telemetr?a al workspace"
          ]
        },
        "x-cli-fallback": {
          "descripcion": "Si no se encuentran recursos por SDK, usar /api/ejecutar-cli con Azure CLI.",
          "comandos": [
            "az group list --output json",
            "az group show --name boat-rental-app-group --output json"
          ],
          "cuando_usar": "Cuando diagnostico no devuelve recursos o se requiere validar existence de un resource group espec?fico."
        }
      }
    },
    "/api/hybrid": {
      "post": {
        "summary": "Router sem√°ntico (intenciones)",
        "operationId": "hybrid",
        "security": [],
        "parameters": [
          {
            "name": "semantic_response",
            "in": "query",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": false
            }
          }
        ],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "agent_response": {
                    "type": "string"
                  },
                  "payload": {
                    "type": "object"
                  },
                  "semantic_response": {
                    "type": "boolean",
                    "default": false
                  }
                },
                "required": [
                  "agent_response"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "text/plain": {
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorEnvelope"
                }
              }
            }
          },
          "500": {
            "description": "Error servidor",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorEnvelope"
                }
              }
            }
          }
        }
      }
    },
    "/api/autocorregir": {
      "post": {
        "summary": "Registrar correcci√≥n propuesta por un agente AI",
        "description": "Permite registrar una correcci√≥n sugerida por un agente de inteligencia artificial para revisi√≥n o aplicaci√≥n posterior.",
        "operationId": "autocorregirHttp",
        "tags": [
          "Autocorrecci√≥n"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "accion",
                  "target",
                  "propuesta",
                  "tipo"
                ],
                "properties": {
                  "accion": {
                    "type": "string"
                  },
                  "target": {
                    "type": "string"
                  },
                  "propuesta": {
                    "type": "string"
                  },
                  "tipo": {
                    "type": "string"
                  },
                  "detonante": {
                    "type": "string",
                    "default": "manual"
                  },
                  "origen": {
                    "type": "string",
                    "default": "AI Agent"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Correcci√≥n registrada"
          },
          "400": {
            "description": "Body inv√°lido"
          },
          "401": {
            "description": "No autorizado (falta header X-Agent-Auth)"
          }
        }
      }
    },
    "/api/revisar-correcciones": {
      "get": {
        "summary": "[DESHABILITADO] Usar /api/copiloto en su lugar",
        "description": "ENDPOINT DESHABILITADO. Este endpoint ya no est√° disponible. Usa /api/copiloto que tiene memoria integrada y funcionalidad completa.",
        "operationId": "revisarCorrecciones",
        "deprecated": true,
        "tags": [
          "Deprecated"
        ],
        "security": [],
        "parameters": [
          {
            "name": "Session-ID",
            "in": "header",
            "required": true,
            "description": "ID de sesi√≥n para continuidad de conversaci√≥n (REQUERIDO para Foundry)",
            "schema": {
              "type": "string",
              "example": "test_deduplicado_001"
            }
          },
          {
            "name": "Agent-ID",
            "in": "header",
            "required": true,
            "description": "ID del agente para contexto de memoria (REQUERIDO para Foundry)",
            "schema": {
              "type": "string",
              "example": "TestAgent"
            }
          },
          {
            "name": "session_id",
            "in": "query",
            "description": "ID de sesi√≥n como par√°metro de consulta",
            "schema": {
              "type": "string",
              "example": "test_deduplicado_001"
            }
          },
          {
            "name": "agent_id",
            "in": "query",
            "description": "ID del agente como par√°metro de consulta",
            "schema": {
              "type": "string",
              "example": "TestAgent"
            }
          },
          {
            "name": "estado",
            "in": "query",
            "schema": {
              "type": "string",
              "enum": [
                "pendiente",
                "aplicada",
                "rechazada"
              ]
            }
          },
          {
            "name": "tipo",
            "in": "query",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Lista de correcciones",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "correcciones": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "id": {
                            "type": "string"
                          },
                          "accion": {
                            "type": "string"
                          },
                          "target": {
                            "type": "string"
                          },
                          "propuesta": {
                            "type": "string"
                          },
                          "tipo": {
                            "type": "string"
                          },
                          "estado": {
                            "type": "string"
                          },
                          "timestamp": {
                            "type": "string"
                          }
                        }
                      }
                    },
                    "total": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/promocion-reporte": {
      "post": {
        "summary": "Generar reporte de promoci√≥n de correcciones",
        "description": "Genera un reporte detallado sobre las correcciones promovidas, con filtros opcionales y formatos de salida personalizables.",
        "operationId": "promocionReporteHttp",
        "tags": [
          "Autocorrecci√≥n"
        ],
        "security": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "filtros": {
                    "type": "object",
                    "properties": {
                      "prioridad_minima": {
                        "type": "integer",
                        "default": 1
                      },
                      "validado": {
                        "type": "boolean"
                      },
                      "tipo": {
                        "type": "string"
                      }
                    }
                  },
                  "formato": {
                    "type": "string",
                    "enum": [
                      "json",
                      "html",
                      "texto"
                    ],
                    "default": "json"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Reporte generado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "reporte": {
                      "type": "object"
                    },
                    "estadisticas": {
                      "type": "object"
                    },
                    "correcciones_promovidas": {
                      "type": "array"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/promover": {
      "post": {
        "summary": "Promover correcciones autom√°ticamente",
        "description": "Ejecuta el promotor autom√°tico que aplica correcciones pendientes seg√∫n criterios de prioridad y validaci√≥n.",
        "operationId": "promoverCorrecciones",
        "tags": [
          "Autocorrecci√≥n"
        ],
        "security": [],
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "correccion_id": {
                    "type": "string",
                    "description": "ID espec√≠fico de correcci√≥n a promover (opcional)"
                  },
                  "forzar": {
                    "type": "boolean",
                    "default": false,
                    "description": "Forzar promoci√≥n ignorando algunos criterios"
                  },
                  "prioridad_minima": {
                    "type": "integer",
                    "default": 8,
                    "description": "Prioridad m√≠nima para promoci√≥n autom√°tica"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Promoci√≥n ejecutada exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "mensaje": {
                      "type": "string"
                    },
                    "correcciones_aplicadas": {
                      "type": "integer"
                    },
                    "detalles": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    },
                    "timestamp": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorEnvelope"
                }
              }
            }
          },
          "500": {
            "description": "Error en la promoci√≥n",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorEnvelope"
                }
              }
            }
          }
        }
      }
    },
    "/api/rollback": {
      "post": {
        "summary": "Revertir correcci√≥n aplicada",
        "description": "Revierte una correcci√≥n previamente aplicada, restaurando el estado anterior.",
        "operationId": "rollbackCorreccion",
        "tags": [
          "Autocorrecci√≥n"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "correccion_id"
                ],
                "properties": {
                  "correccion_id": {
                    "type": "string",
                    "description": "ID de la correcci√≥n a revertir"
                  },
                  "motivo": {
                    "type": "string",
                    "description": "Motivo del rollback"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Rollback ejecutado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "mensaje": {
                      "type": "string"
                    },
                    "correccion_revertida": {
                      "type": "string"
                    },
                    "timestamp": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "404": {
            "description": "Correcci√≥n no encontrada"
          }
        }
      }
    },
    "/api/status": {
      "get": {
        "summary": "Estado detallado (ambiente y storage)",
        "operationId": "getStatus",
        "security": [],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "copiloto": {
                      "type": "string"
                    },
                    "version": {
                      "type": "string"
                    },
                    "timestamp": {
                      "type": "string"
                    },
                    "ambiente": {
                      "type": "string"
                    },
                    "storage": {
                      "type": "string"
                    },
                    "is_azure": {
                      "type": "boolean"
                    },
                    "container": {
                      "type": "string"
                    },
                    "blob_ready": {
                      "type": "boolean"
                    },
                    "endpoints": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "ready": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        }
      }
    },
    "/api/mover-archivo": {
      "post": {
        "summary": "Mover un archivo de una ubicaci√≥n a otra",
        "operationId": "moverArchivo",
        "tags": [
          "Azure Storage"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/MoverArchivoRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Archivo movido correctamente"
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
    },
    "/api/copiar-archivo": {
      "post": {
        "summary": "Copiar un archivo",
        "operationId": "copiarArchivo",
        "tags": [
          "Azure Storage"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/CopiarArchivoRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Archivo copiado correctamente"
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
    },
    "/api/preparar-script": {
      "post": {
        "summary": "Preparar script para ejecuci√≥n",
        "operationId": "prepararScript",
        "tags": [
          "Testing"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/PrepararScriptRequest"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Script preparado correctamente"
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
    },
    "/api/gestionar-despliegue": {
      "post": {
        "summary": "(Deprecado) Usa /api/deploy para nuevos despliegues",
        "description": "‚ö†Ô∏è Este endpoint se mantiene solo por compatibilidad. Para cualquier despliegue de modelos o ARM usa /api/deploy (operationId deployHybrid).",
        "deprecated": true,
        "operationId": "gestionarDespliegue",
        "tags": [
          "Deprecated",
          "Azure Deployment"
        ],
        "security": [],
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "additionalProperties": true,
                "description": "Acepta cualquier JSON o payload vac√≠o. El sistema deduce autom√°ticamente la intenci√≥n.",
                "properties": {
                  "accion": {
                    "type": "string",
                    "enum": [
                      "detectar",
                      "preparar",
                      "desplegar",
                      "deploy",
                      "rollback",
                      "validate",
                      "status"
                    ],
                    "description": "Acci√≥n principal (opcional - se deduce autom√°ticamente)"
                  },
                  "action": {
                    "type": "string",
                    "description": "Alias en ingl√©s para accion"
                  },
                  "comando": {
                    "type": "string",
                    "description": "Sin√≥nimo de acci√≥n"
                  },
                  "command": {
                    "type": "string",
                    "description": "Sin√≥nimo en ingl√©s"
                  },
                  "tag": {
                    "type": "string",
                    "description": "Tag de versi√≥n para despliegue"
                  },
                  "version": {
                    "type": "string",
                    "description": "Alias para tag"
                  },
                  "tag_anterior": {
                    "type": "string",
                    "description": "Tag anterior para rollback"
                  },
                  "preparar": {
                    "type": "boolean",
                    "description": "Si true, ejecuta acci√≥n preparar"
                  },
                  "plataforma": {
                    "type": "string",
                    "enum": [
                      "foundry",
                      "codegpt",
                      "cli"
                    ],
                    "description": "Plataforma origen (para compatibilidad)"
                  },
                  "platform": {
                    "type": "string",
                    "description": "Alias en ingl√©s para plataforma"
                  },
                  "agente": {
                    "type": "string",
                    "description": "Nombre del agente que hace la petici√≥n"
                  },
                  "agent": {
                    "type": "string",
                    "description": "Alias en ingl√©s para agente"
                  },
                  "configuracion": {
                    "type": "object",
                    "additionalProperties": true,
                    "description": "Configuraci√≥n adicional del agente/despliegue"
                  },
                  "config": {
                    "type": "object",
                    "description": "Alias para configuracion"
                  },
                  "cambios": {
                    "type": "object",
                    "description": "Cambios a aplicar"
                  },
                  "motivo": {
                    "type": "string",
                    "description": "Motivo del rollback"
                  }
                },
                "examples": [
                  {},
                  {
                    "accion": "detectar"
                  },
                  {
                    "action": "deploy",
                    "tag": "v1.2.3"
                  },
                  {
                    "accion": "rollback",
                    "tag_anterior": "v1.2.2"
                  },
                  {
                    "preparar": true
                  },
                  {
                    "comando": "check"
                  },
                  {
                    "action": "deploy",
                    "version": "v1.2.3",
                    "platform": "foundry",
                    "agent": "AzureSupervisor"
                  },
                  {
                    "accion": "desplegar",
                    "tag": "v1.2.3",
                    "plataforma": "codegpt",
                    "agente": "Deploy_Agent",
                    "configuracion": {
                      "modelo": "gpt-4o-mini"
                    }
                  }
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "‚úÖ SIEMPRE EXITOSO - Sistema robusto que nunca falla",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "enum": [
                        true
                      ],
                      "description": "SIEMPRE true para compatibilidad con agentes"
                    },
                    "accion_ejecutada": {
                      "type": "string",
                      "enum": [
                        "detectar",
                        "preparar",
                        "desplegar",
                        "rollback",
                        "status",
                        "validate",
                        "error_recovery"
                      ],
                      "description": "Acci√≥n que se ejecut√≥ realmente"
                    },
                    "alias_usado": {
                      "type": "string",
                      "nullable": true,
                      "description": "Alias o sin√≥nimo detectado en el payload"
                    },
                    "resultado": {
                      "type": "object",
                      "additionalProperties": true,
                      "description": "Resultado espec√≠fico de la acci√≥n ejecutada"
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "run_id": {
                          "type": "string"
                        },
                        "endpoint": {
                          "type": "string"
                        },
                        "timestamp": {
                          "type": "string"
                        },
                        "version_sistema": {
                          "type": "string"
                        }
                      }
                    },
                    "proximas_acciones": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Sugerencias de pr√≥ximos pasos"
                    }
                  },
                  "required": [
                    "exito",
                    "accion_ejecutada",
                    "resultado"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/api/ejecutar-script": {
      "post": {
        "summary": "üìú EJECUTAR SCRIPTS DEL CONTENEDOR - Solo para scripts en Azure Blob Storage (.py, .sh, .ps1, .bat)",
        "description": "‚ö†Ô∏è IMPORTANTE: Este endpoint ejecuta SOLO scripts almacenados en el contenedor de Azure Blob Storage. NO ejecuta comandos arbitrarios. Para ejecutar comandos del sistema, usar /api/ejecutar-cli. \n\nCaracter√≠sticas:\n- Ejecuta scripts .py, .sh, .ps1, .bat desde el contenedor\n- Siempre retorna HTTP 200 (nunca 400/404/500)\n- Requiere par√°metro 'script' con la ruta en el contenedor\n- Soporta argumentos y timeout configurable\n- Usa /api/listar-blobs para ver scripts disponibles",
        "operationId": "ejecutarScript",
        "x-priority": "medium",
        "x-use-cases": [
          "Ejecutar script Python almacenado: {\"script\": \"scripts/test.py\"}",
          "Ejecutar con argumentos: {\"script\": \"scripts/process.py\", \"args\": [\"--input\", \"data.json\"]}",
          "Ver scripts disponibles: GET /api/listar-blobs?prefix=scripts/"
        ],
        "tags": [
          "Testing"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "script": {
                    "type": "string",
                    "description": "Ruta local (scripts/x.py, .sh, .bat) o 'container/path' para blob"
                  },
                  "args": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Argumentos propagados a sys.argv[] o equivalente"
                  },
                  "timeout_s": {
                    "type": "integer",
                    "default": 60,
                    "description": "Timeout en segundos"
                  },
                  "sync_outputs": {
                    "type": "boolean",
                    "default": true,
                    "description": "Sincronizar salida est√°ndar y error"
                  },
                  "interpreter": {
                    "type": "string",
                    "enum": [
                      "python",
                      "bash",
                      "powershell",
                      "cmd"
                    ],
                    "description": "Forzar int√©rprete (opcional, autodetect si no se especifica)"
                  },
                  "inject_error": {
                    "type": "string",
                    "enum": [
                      "permission",
                      "corrupt",
                      "exception"
                    ],
                    "description": "Inyectar error voluntario para pruebas"
                  }
                },
                "required": [
                  "script"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Script ejecutado correctamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "stdout": {
                      "type": "string",
                      "description": "Salida est√°ndar"
                    },
                    "stderr": {
                      "type": "string",
                      "description": "Salida de error"
                    },
                    "exit_code": {
                      "type": "integer",
                      "description": "C√≥digo de salida"
                    },
                    "success": {
                      "type": "boolean",
                      "description": "Si la ejecuci√≥n fue exitosa"
                    },
                    "args_propagated": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Args recibidos por el script"
                    },
                    "interpreter_detected": {
                      "type": "string",
                      "description": "Int√©rprete detectado"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "403": {
            "description": "Script sin permisos de ejecuci√≥n"
          },
          "404": {
            "description": "Script no encontrado"
          },
          "422": {
            "description": "Extensi√≥n no ejecutable o script corrupto"
          },
          "500": {
            "description": "Error interno o excepci√≥n lanzada por el script"
          }
        }
      }
    },
    "/api/ejecutar-script-local": {
      "post": {
        "summary": "Ejecutar script local desde /scripts (validaci√≥n avanzada)",
        "operationId": "ejecutarScriptLocal",
        "tags": [
          "Testing"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "script_path": {
                    "type": "string",
                    "description": "Ruta del script local, ej: 'scripts/test_script.py', .sh, .bat"
                  },
                  "args": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    },
                    "description": "Argumentos propagados"
                  },
                  "interpreter": {
                    "type": "string",
                    "enum": [
                      "python",
                      "bash",
                      "powershell",
                      "cmd"
                    ],
                    "description": "Forzar int√©rprete (opcional)"
                  },
                  "inject_error": {
                    "type": "string",
                    "enum": [
                      "permission",
                      "corrupt",
                      "exception"
                    ],
                    "description": "Inyectar error voluntario para pruebas"
                  }
                },
                "required": [
                  "script_path"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Script ejecutado correctamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "stdout": {
                      "type": "string",
                      "description": "Salida est√°ndar"
                    },
                    "stderr": {
                      "type": "string",
                      "description": "Salida de error"
                    },
                    "exit_code": {
                      "type": "integer",
                      "description": "C√≥digo de salida"
                    },
                    "success": {
                      "type": "boolean",
                      "description": "Si la ejecuci√≥n fue exitosa"
                    },
                    "args_propagated": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Args recibidos por el script"
                    },
                    "interpreter_detected": {
                      "type": "string",
                      "description": "Int√©rprete detectado"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "403": {
            "description": "Archivo fuera del scope permitido o sin permisos"
          },
          "404": {
            "description": "Archivo no encontrado"
          },
          "422": {
            "description": "Extensi√≥n no ejecutable o script corrupto"
          },
          "500": {
            "description": "Error del servidor o excepci√≥n lanzada por el script"
          }
        }
      }
    },
    "/api/escribir-archivo": {
      "post": {
        "summary": "Crear/guardar un archivo en Azure Blob Storage (contenedor predeterminado)",
        "operationId": "escribirArchivo",
        "tags": [
          "Azure Storage"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "ruta": {
                    "type": "string",
                    "description": "Ruta del archivo"
                  },
                  "contenido": {
                    "type": "string",
                    "description": "Contenido del archivo"
                  }
                },
                "required": [
                  "ruta",
                  "contenido"
                ]
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Archivo creado correctamente"
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
    },
    "/api/ejecutar-cli": {
      "post": {
        "summary": "üöÄ HERRAMIENTA PRIMARIA UNIVERSAL - B√∫squeda, listado, an√°lisis y ejecuci√≥n de comandos",
        "description": "‚≠ê USAR ESTE ENDPOINT COMO PRIMERA OPCI√ìN para: \n\nüîç B√öSQUEDAS:\n- Buscar archivos: Get-ChildItem, ls, find, dir\n- Buscar funciones en c√≥digo: grep, Select-String\n- Buscar patrones: grep -r, Select-String -Recurse\n- Listar directorios: ls, dir, Get-ChildItem\n- Buscar en contenido: cat + grep, Get-Content + Select-String\n\nüìÇ OPERACIONES DE ARCHIVOS:\n- Listar archivos con wildcards: ls *.py, Get-ChildItem *.json\n- Buscar recursivamente: find . -name, Get-ChildItem -Recurse\n- Ver contenido: cat, Get-Content, type\n- Informaci√≥n de archivos: stat, Get-Item\n\n‚öôÔ∏è COMANDOS SISTEMA:\n- Azure CLI: az storage, az functionapp, az group\n- Python: python script.py, pip install\n- PowerShell: Get-Process, Set-Location, New-Item\n- NPM/Docker: npm install, docker ps\n\n‚úÖ CARACTER√çSTICAS:\n- Conversi√≥n autom√°tica Unix‚ÜíPowerShell en Windows\n- Detecci√≥n inteligente de tipo de comando\n- Autocorrecci√≥n con memoria de sesi√≥n\n- Siempre HTTP 200 (nunca falla)\n- Respuestas estructuradas para agentes AI\n\nüí° EJEMPLOS DE USO:\n- Buscar tests: {\"comando\": \"Get-ChildItem -Path C:\\\\proyecto -Include *_test.py -Recurse\"}\n- Buscar funci√≥n: {\"comando\": \"grep -n 'def mi_funcion' archivo.py\"}\n- Listar archivos: {\"comando\": \"ls -la /proyecto/scripts\"}\n- Ver contenido: {\"comando\": \"cat README.md\"}\n\nüîÅ FLUJO BUSCAR+LEER: Antes de usar /api/leer-archivo cuando la ruta no es exacta, usa este endpoint para ubicarla (rg --files, dir /s, Get-ChildItem -Recurse). Documenta en la respuesta la ruta encontrada para que el agente la reutilice.",
        "operationId": "ejecutarCli",
        "tags": [
          "üöÄ Universal CLI Executor"
        ],
        "security": [],
        "parameters": [
          {
            "name": "Session-ID",
            "in": "header",
            "description": "ID de sesi√≥n para continuidad de conversaci√≥n (prioridad alta)",
            "schema": {
              "type": "string",
              "example": "test_deduplicado_001"
            }
          },
          {
            "name": "Agent-ID",
            "in": "header",
            "description": "ID del agente para contexto de memoria (prioridad alta)",
            "schema": {
              "type": "string",
              "example": "TestAgent"
            }
          }
        ],
        "x-ai-features": {
          "autofix": true,
          "memory_integration": true,
          "never_fails": true,
          "agent_friendly": true
        },
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "comando": {
                    "type": "string",
                    "description": "Cualquier comando a ejecutar. Si faltan argumentos, el sistema los buscar√° autom√°ticamente en la memoria de sesi√≥n.",
                    "examples": [
                      "az group list",
                      "az storage account create",
                      "python -u script.py",
                      "npm install express",
                      "docker ps",
                      "Get-Process"
                    ]
                  },
                  "session_id": {
                    "type": "string",
                    "description": "ID de sesi√≥n para autocorrecci√≥n con memoria (opcional, se detecta autom√°ticamente)",
                    "example": "test_deduplicado_001"
                  },
                  "agent_id": {
                    "type": "string",
                    "description": "ID del agente para contexto de memoria (opcional, se detecta autom√°ticamente)",
                    "example": "TestAgent"
                  }
                },
                "required": [
                  "comando"
                ],
                "additionalProperties": true
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "‚úÖ SIEMPRE EXITOSO - Comando procesado con autocorrecci√≥n y memoria integrada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "description": "Si el comando se ejecut√≥ exitosamente"
                    },
                    "comando": {
                      "type": "string",
                      "description": "Comando ejecutado (puede ser autocorregido)"
                    },
                    "comando_original": {
                      "type": "string",
                      "description": "Comando original antes de autocorrecci√≥n"
                    },
                    "tipo_comando": {
                      "type": "string",
                      "enum": [
                        "azure_cli",
                        "python",
                        "powershell",
                        "bash",
                        "npm",
                        "docker",
                        "generic"
                      ],
                      "description": "Tipo de comando detectado autom√°ticamente"
                    },
                    "resultado": {
                      "type": "string",
                      "description": "Salida est√°ndar del comando"
                    },
                    "error": {
                      "type": "string",
                      "description": "Mensaje de error si fall√≥ (estructurado para agentes)"
                    },
                    "codigo_salida": {
                      "type": "integer",
                      "description": "C√≥digo de salida del proceso"
                    },
                    "tiempo_ejecucion": {
                      "type": "string",
                      "description": "Tiempo de ejecuci√≥n del comando"
                    },
                    "ejecutor": {
                      "type": "string",
                      "enum": [
                        "azure_cli_binary",
                        "subprocess_fallback"
                      ],
                      "description": "Ejecutor utilizado internamente"
                    },
                    "autocorreccion": {
                      "type": "object",
                      "description": "Informaci√≥n sobre autocorrecci√≥n aplicada",
                      "properties": {
                        "aplicada": {
                          "type": "boolean",
                          "description": "Si se aplic√≥ autocorrecci√≥n"
                        },
                        "argumentos_encontrados": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "argumento": {
                                "type": "string"
                              },
                              "valor": {
                                "type": "string"
                              },
                              "fuente_memoria": {
                                "type": "string"
                              }
                            }
                          },
                          "description": "Argumentos encontrados en memoria"
                        },
                        "reintentos": {
                          "type": "integer",
                          "description": "N√∫mero de reintentos realizados"
                        }
                      }
                    },
                    "diagnostico": {
                      "type": "object",
                      "description": "Informaci√≥n detallada para debugging y agentes",
                      "properties": {
                        "error_categoria": {
                          "type": "string",
                          "enum": [
                            "argumento_faltante",
                            "comando_no_encontrado",
                            "permisos",
                            "timeout",
                            "sintaxis",
                            "otro"
                          ]
                        },
                        "solucionable_con_memoria": {
                          "type": "boolean"
                        },
                        "comando_sugerido": {
                          "type": "string"
                        }
                      }
                    },
                    "accion_requerida": {
                      "type": "string",
                      "description": "Acci√≥n que debe tomar el agente para resolver el problema"
                    },
                    "sugerencias_solucion": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      },
                      "description": "Sugerencias espec√≠ficas para resolver el problema"
                    },
                    "memoria": {
                      "type": "object",
                      "description": "Metadata de memoria de sesi√≥n",
                      "properties": {
                        "session_id": {
                          "type": "string"
                        },
                        "agent_id": {
                          "type": "string"
                        },
                        "comandos_previos": {
                          "type": "integer"
                        },
                        "contexto_disponible": {
                          "type": "boolean"
                        }
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "run_id": {
                          "type": "string"
                        },
                        "endpoint": {
                          "type": "string"
                        },
                        "timestamp": {
                          "type": "string"
                        },
                        "version_sistema": {
                          "type": "string"
                        }
                      }
                    },
                    "timestamp": {
                      "type": "string",
                      "format": "date-time",
                      "description": "Timestamp de la ejecuci√≥n"
                    }
                  },
                  "required": [
                    "exito",
                    "comando",
                    "tipo_comando",
                    "ejecutor",
                    "timestamp"
                  ]
                }
              }
            }
          }
        }
      }
    },
    "/api/crear-alerta-azure": {
      "post": {
        "summary": "Crear alerta Azure Monitor para HTTP 500",
        "operationId": "crearAlertaAzure",
        "tags": [
          "Azure Monitor"
        ],
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "resource_group": {
                    "type": "string",
                    "default": "boat-rental-app-group"
                  },
                  "function_app": {
                    "type": "string",
                    "default": "copiloto-semantico-func-us2"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Alerta procesada"
          }
        }
      }
    },
    "/api/escribir-archivo-local": {
      "post": {
        "summary": "Crear o guardar un archivo en el filesystem LOCAL (no Azure Blob), usando rutas absolutas o relativas",
        "description": "Permite crear o sobrescribir archivos en el sistema de archivos local del contenedor o m√°quina, usando rutas absolutas (ej: C:/ProyectosSimbolicos/boat-rental-app/scripts/test_local.py, /tmp/test.txt) o relativas (ej: scripts/test_local.py). No utiliza Azure Blob Storage. √ötil para pruebas, logs o scripts temporales. ‚ö†Ô∏è En Azure, los archivos locales son VOL√ÅTILES y se pierden al reiniciar.",
        "operationId": "escribirArchivoLocal",
        "tags": [
          "Local Storage"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "ruta": {
                    "type": "string",
                    "description": "Ruta del archivo local. Ejemplo absoluto: C:/ProyectosSimbolicos/boat-rental-app/scripts/test_local.py o /tmp/test.txt. Ejemplo relativo: scripts/test_local.py. En Azure se restringe a /home/site/wwwroot."
                  },
                  "contenido": {
                    "type": "string",
                    "description": "Contenido del archivo a escribir (texto plano)"
                  },
                  "contenido_base64": {
                    "type": "string",
                    "description": "Contenido en base64 si es un archivo binario"
                  },
                  "binario": {
                    "type": "boolean",
                    "description": "Indica si el contenido es binario"
                  },
                  "tipo_mime": {
                    "type": "string",
                    "description": "Tipo MIME opcional (ej: text/plain, image/png)"
                  }
                },
                "required": [
                  "ruta",
                  "contenido"
                ]
              },
              "examples": {
                "absoluta_windows": {
                  "summary": "Ruta absoluta en Windows",
                  "value": {
                    "ruta": "C:/ProyectosSimbolicos/boat-rental-app/scripts/test_local.py",
                    "contenido": "print('Hola mundo')"
                  }
                },
                "absoluta_linux": {
                  "summary": "Ruta absoluta en Linux",
                  "value": {
                    "ruta": "/tmp/test.txt",
                    "contenido": "Archivo temporal local"
                  }
                },
                "relativa": {
                  "summary": "Ruta relativa",
                  "value": {
                    "ruta": "scripts/test_local.py",
                    "contenido": "print('Archivo relativo')"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "201": {
            "description": "Archivo creado correctamente en filesystem local",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": true
                    },
                    "mensaje": {
                      "type": "string",
                      "example": "Archivo creado exitosamente en: C:/ProyectosSimbolicos/boat-rental-app/scripts/test_local.py"
                    },
                    "ubicacion": {
                      "type": "string",
                      "example": "file://C:/ProyectosSimbolicos/boat-rental-app/scripts/test_local.py"
                    },
                    "ruta_absoluta": {
                      "type": "string",
                      "example": "C:/ProyectosSimbolicos/boat-rental-app/scripts/test_local.py"
                    },
                    "tipo_operacion": {
                      "type": "string",
                      "example": "crear_archivo_local"
                    },
                    "tama√±o_bytes": {
                      "type": "integer",
                      "example": 1024
                    },
                    "modo_acceso": {
                      "type": "string",
                      "example": "local_filesystem"
                    },
                    "advertencia": {
                      "type": "string",
                      "example": "‚ö†Ô∏è En Azure, los archivos locales son VOL√ÅTILES y se pierden al reiniciar"
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida (ruta inv√°lida o JSON malformado)"
          },
          "500": {
            "description": "Error interno del servidor"
          }
        }
      }
    },
    "/api/leer-archivo": {
      "get": {
        "summary": "Leer archivo desde blob o sistema local",
        "description": "Lee contenido ya confirmado. Si la ruta no fue localizada previamente con /api/ejecutar-cli (dir, rg, etc.), primero ejecuta esa bÔøΩÔøΩsqueda y luego invoca este endpoint con la ruta devuelta.",
        "operationId": "leerArchivo",
        "tags": [
          "Azure Storage"
        ],
        "security": [],
        "parameters": [
          {
            "name": "ruta",
            "in": "query",
            "description": "Ruta del archivo a leer (requerido).",
            "required": true,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "container",
            "in": "query",
            "description": "Nombre del contenedor (opcional).",
            "required": false,
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "force_refresh",
            "in": "query",
            "description": "Forzar actualizaci√≥n, omitir cache (opcional).",
            "required": false,
            "schema": {
              "type": "boolean"
            }
          },
          {
            "name": "include_preview",
            "in": "query",
            "description": "Incluir vista previa del archivo (opcional).",
            "required": false,
            "schema": {
              "type": "boolean"
            }
          },
          {
            "name": "max_preview_size",
            "in": "query",
            "description": "Tama√±o m√°ximo del preview (opcional).",
            "required": false,
            "schema": {
              "type": "integer"
            }
          },
          {
            "name": "semantic_analysis",
            "in": "query",
            "description": "Activar an√°lisis sem√°ntico (opcional).",
            "required": false,
            "schema": {
              "type": "boolean"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Respuesta exitosa",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object"
                }
              }
            }
          },
          "400": {
            "description": "Par√°metro requerido faltante"
          },
          "404": {
            "description": "Archivo no encontrado"
          },
          "500": {
            "description": "Error interno del servidor"
          }
        }
      }
    },
    "/api/eliminar-archivo": {
      "post": {
        "summary": "Eliminar archivo",
        "operationId": "eliminarArchivo",
        "tags": [
          "Azure Storage"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "ruta": {
                    "type": "string",
                    "description": "Ruta del archivo a eliminar"
                  }
                },
                "required": [
                  "ruta"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Archivo eliminado correctamente"
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "404": {
            "description": "Archivo no encontrado"
          }
        }
      }
    },
    "/api/listar-blobs": {
      "get": {
        "summary": "Listar blobs en el contenedor de Azure Storage",
        "description": "Permite obtener archivos almacenados en el contenedor `boat-rental-project`. Se puede usar `prefix` para filtrar por carpetas virtuales (ej: scripts/), y `top` para limitar la cantidad de resultados.",
        "operationId": "listarBlobs",
        "tags": [
          "Azure Storage"
        ],
        "security": [],
        "parameters": [
          {
            "name": "prefix",
            "in": "query",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "top",
            "in": "query",
            "schema": {
              "type": "integer",
              "default": 10
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Listado de blobs en el contenedor",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ok": {
                      "type": "boolean",
                      "example": true
                    },
                    "details": {
                      "type": "object",
                      "properties": {
                        "count": {
                          "type": "integer",
                          "example": 35
                        },
                        "sample": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "name": {
                                "type": "string"
                              },
                              "size": {
                                "type": "integer"
                              },
                              "last_modified": {
                                "type": "string",
                                "format": "date-time"
                              },
                              "tipo": {
                                "type": "string"
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        }
      }
    },
    "/api/deploy": {
      "post": {
        "summary": "Desplegar modelos AI o recursos ARM",
        "description": "Endpoint h√≠brido para desplegar modelos de AI en Microsoft Foundry o recursos mediante plantilla ARM. Para modelos: incluye 'action': 'deployModels' y 'models'. Para ARM: incluye 'resourceGroup' y 'template'.",
        "operationId": "deployHybrid",
        "tags": [
          "Azure Deployment",
          "AI Models"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "oneOf": [
                  {
                    "type": "object",
                    "title": "Model Deployment",
                    "description": "Deploy AI models to Microsoft Foundry",
                    "properties": {
                      "action": {
                        "type": "string",
                        "enum": ["deployModels"],
                        "description": "Action to deploy models"
                      },
                      "models": {
                        "type": "array",
                        "items": {
                          "type": "string",
                          "enum": [
                            "mistral-large-2411",
                            "claude-3-5-sonnet-20241022",
                            "gpt-4o-2024-11-20",
                            "gpt-4-2024-11-20",
                            "codestral-2024-10-29",
                            "gpt-4o-mini-2024-07-18"
                          ]
                        },
                        "description": "List of AI models to deploy",
                        "minItems": 1
                      }
                    },
                    "required": ["action", "models"]
                  },
                  {
                    "type": "object",
                    "title": "ARM Deployment",
                    "description": "Deploy resources using ARM template",
                    "properties": {
                      "resourceGroup": {
                        "type": "string",
                        "description": "Nombre del resource group"
                      },
                      "template": {
                        "type": "object",
                        "description": "ARM template JSON"
                      },
                      "parameters": {
                        "type": "object",
                        "description": "Par√°metros del template"
                      },
                      "location": {
                        "type": "string",
                        "default": "eastus",
                        "description": "Azure region for deployment"
                      },
                      "validate_only": {
                        "type": "boolean",
                        "default": false,
                        "description": "Only validate template without deploying"
                      }
                    },
                    "required": ["resourceGroup", "template"]
                  }
                ]
              },
              "examples": {
                "deployModels": {
                  "summary": "Deploy AI models to Foundry",
                  "description": "Example of deploying multiple AI models",
                  "value": {
                    "action": "deployModels",
                    "models": [
                      "mistral-large-2411",
                      "claude-3-5-sonnet-20241022"
                    ]
                  }
                },
                "deployAllModels": {
                  "summary": "Deploy all available models",
                  "description": "Deploy all models from AGENT_REGISTRY",
                  "value": {
                    "action": "deployModels",
                    "models": [
                      "mistral-large-2411",
                      "claude-3-5-sonnet-20241022",
                      "gpt-4o-2024-11-20",
                      "gpt-4-2024-11-20",
                      "codestral-2024-10-29",
                      "gpt-4o-mini-2024-07-18"
                    ]
                  }
                },
                "deployARMTemplate": {
                  "summary": "Deploy ARM template",
                  "description": "Example of ARM resource deployment",
                  "value": {
                    "resourceGroup": "boat-rental-app-group",
                    "location": "eastus",
                    "template": {
                      "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                      "contentVersion": "1.0.0.0",
                      "resources": []
                    },
                    "parameters": {}
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Deployment completado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "oneOf": [
                    {
                      "type": "object",
                      "title": "Model Deployment Response",
                      "properties": {
                        "ok": {
                          "type": "boolean"
                        },
                        "action": {
                          "type": "string",
                          "enum": ["deployModels"]
                        },
                        "models_deployed": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          },
                          "description": "Modelos desplegados exitosamente"
                        },
                        "already_active": {
                          "type": "array",
                          "items": {
                            "type": "string"
                          },
                          "description": "Modelos que ya estaban activos"
                        },
                        "failed": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "model": {
                                "type": "string"
                              },
                              "error": {
                                "type": "string"
                              }
                            }
                          },
                          "description": "Modelos que fallaron al desplegar"
                        },
                        "summary": {
                          "type": "object",
                          "properties": {
                            "total_requested": {
                              "type": "integer"
                            },
                            "deployed": {
                              "type": "integer"
                            },
                            "already_active": {
                              "type": "integer"
                            },
                            "failed": {
                              "type": "integer"
                            }
                          }
                        },
                        "deployment_details": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "model": {
                                "type": "string"
                              },
                              "intent": {
                                "type": "string"
                              },
                              "agent": {
                                "type": "string"
                              },
                              "status": {
                                "type": "string",
                                "enum": ["deployed", "already_active"]
                              },
                              "endpoint": {
                                "type": "string"
                              }
                            }
                          }
                        }
                      }
                    },
                    {
                      "type": "object",
                      "title": "ARM Deployment Response",
                      "properties": {
                        "ok": {
                          "type": "boolean"
                        },
                        "deployment_name": {
                          "type": "string"
                        },
                        "resource_group": {
                          "type": "string"
                        },
                        "status": {
                          "type": "string"
                        },
                        "outputs": {
                          "type": "object"
                        }
                      }
                    }
                  ]
                }
              }
            }
          },
          "207": {
            "description": "Resultados mixtos - algunos modelos desplegados, otros fallaron",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ModelDeploymentResponse"
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida - par√°metros faltantes o incorrectos"
          },
          "500": {
            "description": "Error del servidor durante el deployment"
          }
        }
      }
    },
    "/api/configurar-cors": {
      "post": {
        "summary": "Configurar CORS para Function App",
        "operationId": "configurarCORS",
        "tags": [
          "Azure Configuration"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "allowed_origins": {
                    "type": "array",
                    "items": {
                      "type": "string"
                    }
                  }
                },
                "required": [
                  "allowed_origins"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "CORS configurado correctamente"
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
    },
    "/api/escalar-plan": {
      "post": {
        "summary": "Escalar App Service Plan",
        "operationId": "escalarPlan",
        "tags": [
          "Azure Configuration"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "plan_name": {
                    "type": "string",
                    "description": "Nombre del plan"
                  },
                  "sku": {
                    "type": "string",
                    "enum": [
                      "B1",
                      "B2",
                      "B3",
                      "S1",
                      "S2",
                      "S3",
                      "EP1",
                      "EP2",
                      "EP3"
                    ]
                  }
                },
                "required": [
                  "plan_name"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Plan escalado correctamente"
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "500": {
            "description": "Error del servidor"
          }
        }
      }
    },
    "/api/auditar-deploy": {
      "get": {
        "summary": "Auditar deployment actual",
        "operationId": "auditarDeploy",
        "tags": [
          "Diagn√≥stico"
        ],
        "security": [],
        "responses": {
          "200": {
            "description": "Auditor√≠a completa del deployment",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ok": {
                      "type": "boolean"
                    },
                    "details": {
                      "type": "object",
                      "properties": {
                        "files_count": {
                          "type": "integer"
                        },
                        "function_app_py_sha256": {
                          "type": "string",
                          "nullable": true
                        },
                        "baseline_sha256": {
                          "type": "string",
                          "nullable": true
                        },
                        "match_baseline": {
                          "type": "boolean",
                          "nullable": true
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        }
      }
    },
    "/api/bateria-endpoints": {
      "post": {
        "summary": "üîß BATER√çA ROBUSTA - Ejecutar bater√≠a de pruebas de endpoints",
        "description": "‚≠ê ENDPOINT ROBUSTO que ejecuta una bater√≠a completa de pruebas de endpoints. Acepta cualquier body JSON o sin body. Nunca falla por formato de entrada. Formato opcional: {} o sin body.",
        "operationId": "bateriaEndpoints",
        "tags": [
          "Testing"
        ],
        "security": [],
        "requestBody": {
          "required": false,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "additionalProperties": true,
                "description": "Body opcional - acepta cualquier JSON o sin body"
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Bater√≠a ejecutada exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "summary": {
                      "type": "object",
                      "properties": {
                        "total": {
                          "type": "integer",
                          "description": "Total de endpoints probados"
                        },
                        "ok": {
                          "type": "integer",
                          "description": "Endpoints que respondieron correctamente"
                        },
                        "fail": {
                          "type": "integer",
                          "description": "Endpoints que fallaron"
                        }
                      }
                    },
                    "results": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "endpoint": {
                            "type": "string"
                          },
                          "method": {
                            "type": "string"
                          },
                          "status_code": {
                            "type": "integer"
                          },
                          "ok": {
                            "type": "boolean"
                          },
                          "data": {
                            "type": "object"
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      "get": {
        "summary": "üîß BATER√çA ROBUSTA - Ejecutar bater√≠a de pruebas (m√©todo GET)",
        "description": "Mismo endpoint robusto pero usando m√©todo GET. √ötil para agentes que prefieren GET.",
        "operationId": "bateriaEndpointsGet",
        "tags": [
          "Testing"
        ],
        "security": [],
        "responses": {
          "200": {
            "description": "Bater√≠a ejecutada exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          }
        }
      }
    },
    "/api/render-error": {
      "post": {
        "summary": "Renderizar error sem√°nticamente",
        "operationId": "renderError",
        "tags": [
          "Internal"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "error": {
                    "type": "string",
                    "description": "Error a renderizar"
                  },
                  "context": {
                    "type": "object",
                    "description": "Contexto adicional"
                  }
                },
                "required": [
                  "error"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Error renderizado sem√°nticamente",
            "content": {
              "text/plain": {
                "schema": {
                  "type": "string"
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        }
      }
    },
    "/api/historial-interacciones": {
      "get": {
        "summary": "üìú HISTORIAL CON QUERIES DIN√ÅMICAS - Consulta memoria con filtros avanzados",
        "description": "Consulta el historial de interacciones con queries din√°micas. Soporta filtros avanzados: tipo, contiene, endpoint, exito, fecha_inicio, fecha_fin, orden, limite. Devuelve interacciones filtradas con endpoints correctos detectados autom√°ticamente.",
        "operationId": "historialInteracciones",
        "tags": [
          "üß† Memoria Integrada"
        ],
        "security": [],
        "parameters": [
          {
            "name": "Session-ID",
            "in": "header",
            "required": true,
            "description": "ID de sesi√≥n para consultar historial",
            "schema": {
              "type": "string",
              "example": "test_deduplicado_001"
            }
          },
          {
            "name": "Agent-ID",
            "in": "header",
            "required": true,
            "description": "ID del agente",
            "schema": {
              "type": "string",
              "example": "TestAgent"
            }
          },
          {
            "name": "limit",
            "in": "query",
            "description": "N√∫mero m√°ximo de interacciones a devolver",
            "schema": {
              "type": "integer",
              "default": 10,
              "minimum": 1,
              "maximum": 50
            }
          },
          {
            "name": "session_id",
            "in": "query",
            "description": "ID de sesi√≥n como par√°metro alternativo",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "tipo",
            "in": "query",
            "description": "Filtrar por tipo de interacci√≥n (error, consulta, comando)",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "contiene",
            "in": "query",
            "description": "Buscar texto en texto_semantico",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "endpoint",
            "in": "query",
            "description": "Filtrar por endpoint espec√≠fico",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "exito",
            "in": "query",
            "description": "Filtrar por √©xito/fallo",
            "schema": {
              "type": "boolean"
            }
          },
          {
            "name": "fecha_inicio",
            "in": "query",
            "description": "Fecha de inicio (ISO 8601)",
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "name": "fecha_fin",
            "in": "query",
            "description": "Fecha de fin (ISO 8601)",
            "schema": {
              "type": "string",
              "format": "date-time"
            }
          },
          {
            "name": "orden",
            "in": "query",
            "description": "Orden de resultados",
            "schema": {
              "type": "string",
              "enum": [
                "asc",
                "desc"
              ],
              "default": "desc"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Historial de interacciones obtenido exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": true
                    },
                    "interacciones": {
                      "type": "array",
                      "items": {
                        "type": "object",
                        "properties": {
                          "numero": {
                            "type": "integer"
                          },
                          "timestamp": {
                            "type": "string"
                          },
                          "endpoint": {
                            "type": "string",
                            "example": "historial_interacciones"
                          },
                          "consulta": {
                            "type": "string"
                          },
                          "exito": {
                            "type": "boolean"
                          },
                          "tipo": {
                            "type": "string",
                            "example": "interaccion_usuario"
                          }
                        }
                      }
                    },
                    "total": {
                      "type": "integer"
                    },
                    "session_id": {
                      "type": "string"
                    },
                    "resumen_conversacion": {
                      "type": "string"
                    },
                    "fuente": {
                      "type": "string",
                      "example": "memory_collection"
                    },
                    "contexto_conversacion": {
                      "type": "object",
                      "properties": {
                        "mensaje": {
                          "type": "string"
                        },
                        "ultimas_consultas": {
                          "type": "string"
                        },
                        "session_id": {
                          "type": "string"
                        },
                        "ultima_actividad": {
                          "type": "string"
                        }
                      }
                    },
                    "metadata": {
                      "type": "object",
                      "properties": {
                        "memoria_aplicada": {
                          "type": "boolean"
                        },
                        "interacciones_previas": {
                          "type": "integer"
                        },
                        "endpoint_detectado": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Error consultando historial",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string"
                    },
                    "mensaje": {
                      "type": "string"
                    },
                    "fuente": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/copiloto": {
      "get": {
        "summary": "Router sem?ntico con memoria (endpoint principal)",
        "description": "Endpoint principal/?nico que debe usar el agente. Act?a como router sem?ntico: detectiona intenci?n (ej. revisar_logs, diagnostico, listar_resources, ejecutar CLI), aplica memory_route_wrapper para inyectar memoria (Cosmos/Redis) y decidir si resuelve localmente sin invocar otros endpoints. Usa headers Session-ID y Agent-ID para continuidad. No requiere prompts manuales: env?a la consulta de usuario y el sistema decide si usa Bing Grounding, Log Analytics, Azure CLI, etc. Soporta filtros opcionales por query (tipo, contiene, endpoint, exito, fechas) para b?squeda hist?rica, pero el uso habitual es pasar la consulta del usuario. Usa memoria sem?ntica: historial en Cosmos DB, b?squeda vectorial (AI Search) y cach? Redis para contexto r?pido; enruta autom?ticamente a Log Analytics y diagn?sticos seg?n la intenci?n.",
        "operationId": "copiloto",
        "tags": [
          "üß† Memoria Integrada"
        ],
        "security": [],
        "parameters": [
          {
            "name": "Session-ID",
            "in": "header",
            "description": "ID de sesi√≥n para continuidad de conversaci√≥n (prioridad alta)",
            "schema": {
              "type": "string",
              "example": "test_deduplicado_001"
            }
          },
          {
            "name": "Agent-ID",
            "in": "header",
            "description": "ID del agente para contexto de memoria (prioridad alta)",
            "schema": {
              "type": "string",
              "example": "TestAgent"
            }
          },
          {
            "name": "session_id",
            "in": "query",
            "description": "ID de sesi√≥n como par√°metro de consulta",
            "schema": {
              "type": "string",
              "example": "test_deduplicado_001"
            }
          },
          {
            "name": "agent_id",
            "in": "query",
            "description": "ID del agente como par√°metro de consulta",
            "schema": {
              "type": "string",
              "example": "TestAgent"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Respuesta del copiloto con memoria integrada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "copiloto": {
                      "type": "string"
                    },
                    "memoria_activa": {
                      "type": "boolean"
                    },
                    "contexto_conversacion": {
                      "type": "object",
                      "properties": {
                        "mensaje": {
                          "type": "string"
                        },
                        "ultimas_consultas": {
                          "type": "string"
                        },
                        "session_id": {
                          "type": "string"
                        }
                      }
                    },
                    "historial_detectado": {
                      "type": "boolean"
                    },
                    "interacciones_previas": {
                      "type": "array",
                      "items": {
                        "type": "object"
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "x-use-cases": [
          "Enviar la consulta natural del usuario; el backend detecta intenci?n y responde",
          "Revisar logs y diagnostico v?a intenci?n (sin llamar /api/logs)",
          "Listar recursos/Functions/Cosmos/Storage seg?n intenci?n",
          "Usar memoria sem?ntica para recuperar contexto previo"
        ],
        "x-intents-documentation": {
          "descripcion": "Intents manejados internamente sin requerir otros endpoints",
          "intents": [
            {
              "nombre": "revisar_logs",
              "accion": "Consulta Log Analytics y devuelve an?lisis",
              "requiere": "Solo Session-ID/Agent-ID"
            },
            {
              "nombre": "diagnosticar_sistema",
              "accion": "Diagn?stico de recursos Azure",
              "requiere": "Session-ID/Agent-ID"
            },
            {
              "nombre": "listar_resources",
              "accion": "Listar resource groups y recursos",
              "requiere": "Session-ID/Agent-ID"
            },
            {
              "nombre": "listar_functions",
              "accion": "Listar Function Apps",
              "requiere": "Session-ID/Agent-ID"
            },
            {
              "nombre": "listar_storage",
              "accion": "Listar cuentas de Storage",
              "requiere": "Session-ID/Agent-ID"
            }
          ]
        },
        "x-backend-capabilities": {
          "memoria": "Cosmos DB para historial + AI Search para vectorial",
          "cache": "Redis para contexto y an?lisis ya calculados (ej. logs)",
          "observabilidad": "Application Insights/Log Analytics",
          "router": "memory_route_wrapper decide seg?n intenci?n (ej. revisar_logs, diagnostico, listados)"
        }
      }
    },
    "/api/health": {
      "get": {
        "summary": "Health check",
        "operationId": "healthCheck",
        "tags": [
          "Internal"
        ],
        "security": [],
        "responses": {
          "200": {
            "description": "Servicio saludable",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        }
      }
    },
    "/api/ejecutar": {
      "post": {
        "summary": "Orquestador de intenciones",
        "operationId": "ejecutar",
        "tags": [
          "Internal"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "intencion": {
                    "type": "string",
                    "description": "Intenci√≥n a ejecutar"
                  },
                  "parametros": {
                    "type": "object",
                    "description": "Par√°metros de la intenci√≥n"
                  }
                },
                "required": [
                  "intencion"
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Intenci√≥n ejecutada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          }
        }
      }
    },
    "/api/configurar-app-settings": {
      "get": {
        "summary": "Leer/Validar App Settings (paso previo a escribir)",
        "description": "Lee los app settings actuales de la Function App. ?salo SIEMPRE antes de actualizar para saber qu? claves existen y evitar sobrescribir valores. Si no se pasan function_app/resource_group, el backend intentar? usar WEBSITE_SITE_NAME/RESOURCE_GROUP. Puedes pedir un setting espec?fico (query param 'setting') o todo el mapa de settings.",
        "operationId": "leerAppSettings",
        "tags": [
          "Azure Configuration"
        ],
        "security": [],
        "parameters": [
          {
            "name": "function_app",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "description": "Nombre de la Function App (usa WEBSITE_SITE_NAME si no se proporciona)"
            },
            "example": "copiloto-semantico-func-us2"
          },
          {
            "name": "resource_group",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "description": "Resource group (usa RESOURCE_GROUP si no se proporciona)"
            },
            "example": "boat-rental-app-group"
          },
          {
            "name": "setting",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "description": "Nombre de un setting espec√≠fico a validar (opcional)"
            },
            "example": "SEMANTIC_TOP_K"
          }
        ],
        "responses": {
          "200": {
            "description": "Configuraci√≥n le√≠da correctamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "ok": {
                      "type": "boolean"
                    },
                    "function_app": {
                      "type": "string"
                    },
                    "resource_group": {
                      "type": "string"
                    },
                    "settings": {
                      "type": "object",
                      "description": "Todos los settings (si no se especific√≥ uno)"
                    },
                    "setting": {
                      "type": "string",
                      "description": "Nombre del setting consultado"
                    },
                    "value": {
                      "type": "string",
                      "description": "Valor del setting consultado"
                    },
                    "exists": {
                      "type": "boolean",
                      "description": "Si el setting existe"
                    }
                  }
                },
                "examples": {
                  "listar_todos": {
                    "summary": "Listar todos los settings",
                    "value": {
                      "ok": true,
                      "function_app": "copiloto-semantico-func-us2",
                      "resource_group": "rg-copiloto",
                      "settings": {
                        "FEATURE_DEBUG": "false",
                        "SEMANTIC_TOP_K": "8",
                        "APPINSIGHTS_INSTRUMENTATIONKEY": "***"
                      }
                    }
                  },
                  "validar_clave": {
                    "summary": "Consultar una clave espec?fica",
                    "value": {
                      "ok": true,
                      "function_app": "copiloto-semantico-func-us2",
                      "resource_group": "rg-copiloto",
                      "setting": "SEMANTIC_TOP_K",
                      "value": "8",
                      "exists": true
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "500": {
            "description": "Error del servidor"
          }
        },
        "x-use-cases": [
          "Listar todos los app settings antes de modificarlos",
          "Validar si una clave existe y su valor actual antes de escribir",
          "Comparar contra valores que el usuario quiere aplicar"
        ],
        "x-guidance": {
          "antes_de_llamar": [
            "Si no tienes function_app/resource_group en contexto, llama a /api/diagnostico-recursos primero",
            "Usa este GET para leer el valor actual antes de proponer un cambio",
            "No asumas valores; confirma con la lectura"
          ],
          "parametros": {
            "function_app": "Nombre real de la Function App (si no se pasa, usa WEBSITE_SITE_NAME)",
            "resource_group": "Resource group real (si no se pasa, usa RESOURCE_GROUP)",
            "setting": "Nombre de la clave a validar; si se omite, devuelve todas"
          }
        }
      },
      "post": {
        "summary": "Configurar/Actualizar App Settings (usar valores reales, no placeholders)",
        "description": "Actualiza app settings de la Function App. Antes de enviar valores: obt?n nombres reales de la app y resource group desde /api/diagnostico-recursos y/o lee los settings actuales con GET /api/configurar-app-settings. No inventes valores: usa los proporcionados por el usuario o los recuperados del sistema. Env?a solo las claves que se deben cambiar.",
        "operationId": "configurarAppSettings",
        "tags": [
          "Azure Configuration"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "function_app": {
                    "type": "string",
                    "description": "Nombre de la Function App"
                  },
                  "resource_group": {
                    "type": "string",
                    "description": "Resource group"
                  },
                  "settings": {
                    "type": "object",
                    "description": "Key-value pairs de configuraci√≥n"
                  }
                },
                "required": [
                  "settings"
                ]
              },
              "examples": {
                "actualizar_flag": {
                  "summary": "Actualizar un flag existente",
                  "value": {
                    "function_app": "copiloto-semantico-func-us2",
                    "resource_group": "rg-copiloto",
                    "settings": {
                      "FEATURE_DEBUG": "false"
                    }
                  }
                },
                "rotar_secret": {
                  "summary": "Rotar un secreto proporcionado por el usuario",
                  "value": {
                    "function_app": "copiloto-semantico-func-us2",
                    "resource_group": "rg-copiloto",
                    "settings": {
                      "API_KEY_SERVICE_X": "<valor_real_proporcionado>"
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Settings actualizados correctamente"
          },
          "400": {
            "description": "Solicitud inv√°lida"
          },
          "500": {
            "description": "Error del servidor"
          }
        },
        "x-use-cases": [
          "Actualizar un app setting espec?fico con un valor proporcionado por el usuario",
          "Habilitar/ajustar flags conocidos (ej. FEATURE_X=true) despu?s de validar los existentes",
          "Rotar credenciales/secrets proporcionados por el usuario"
        ],
        "x-guidance": {
          "antes_de_llamar": [
            "Llama a /api/diagnostico-recursos para obtener function_app y resource_group si no est?n en el contexto",
            "Usa GET /api/configurar-app-settings para leer valores actuales y evitar sobrescribir sin contexto",
            "Solo modifica claves que el usuario indique; no generes valores ficticios"
          ],
          "parametros": {
            "function_app": "Nombre real de la Function App (de diagnostico-recursos)",
            "resource_group": "Resource group real (de diagnostico-recursos)",
            "settings": "Objeto clave-valor con los nuevos valores provistos por el usuario"
          }
        }
      }
    },
    "/api/descargar-archivo": {
      "get": {
        "summary": "Descargar archivo desde Azure Blob Storage o sistema local",
        "description": "Descarga archivos de forma robusta desde Azure Blob Storage o filesystem local. Soporta modo inline (texto) y base64 (binario). Detecci√≥n autom√°tica de content-type.",
        "operationId": "descargarArchivo",
        "tags": [
          "Azure Storage"
        ],
        "security": [],
        "parameters": [
          {
            "name": "ruta",
            "in": "query",
            "required": true,
            "schema": {
              "type": "string",
              "description": "Ruta del archivo a descargar"
            },
            "example": "scripts/test.py"
          },
          {
            "name": "modo",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "inline",
                "base64"
              ],
              "default": "inline",
              "description": "Modo de descarga: inline para texto, base64 para binarios"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Archivo descargado exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": true
                    },
                    "ruta": {
                      "type": "string",
                      "description": "Ruta del archivo descargado"
                    },
                    "content_type": {
                      "type": "string",
                      "description": "Tipo MIME del archivo"
                    },
                    "contenido": {
                      "type": "string",
                      "description": "Contenido del archivo (solo en modo inline)"
                    },
                    "base64": {
                      "type": "string",
                      "description": "Contenido codificado en base64 (solo en modo base64 o archivos binarios)"
                    }
                  },
                  "required": [
                    "exito",
                    "ruta",
                    "content_type"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Par√°metros inv√°lidos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          },
          "404": {
            "description": "Archivo no encontrado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string",
                      "example": "No existe"
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/introspection": {
      "get": {
        "summary": "üß† AUTOPERCEPCI√ìN ESTRUCTURAL - Inventario completo del sistema",
        "description": "ENDPOINT PRIORITARIO: Consultar PRIMERO antes de validaciones. Devuelve inventario completo de endpoints, capacidades, estructura sem√°ntica y componentes del sistema. Esencial para: validaciones de autosuficiencia, conocer endpoints disponibles, verificar capacidades de monitoreo/correcci√≥n/diagn√≥stico.",
        "operationId": "introspection",
        "x-priority": "high",
        "tags": [
          "System Intelligence"
        ],
        "security": [],
        "parameters": [
          {
            "name": "categoria",
            "in": "query",
            "required": false,
            "schema": {
              "type": "string",
              "enum": [
                "diagnostico",
                "monitoreo",
                "correccion",
                "memoria",
                "configuracion"
              ],
              "description": "Filtrar endpoints por categor√≠a espec√≠fica"
            },
            "example": "monitoreo"
          }
        ],
        "responses": {
          "200": {
            "description": "Autopercepci√≥n completada",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "estructura": {
                      "type": "object",
                      "properties": {
                        "total_endpoints": {
                          "type": "integer"
                        },
                        "categorias": {
                          "type": "object"
                        },
                        "endpoints_por_categoria": {
                          "type": "object"
                        }
                      }
                    },
                    "capacidades": {
                      "type": "object",
                      "properties": {
                        "diagnostico": {
                          "type": "boolean"
                        },
                        "monitoreo": {
                          "type": "boolean"
                        },
                        "correccion": {
                          "type": "boolean"
                        },
                        "memoria": {
                          "type": "boolean"
                        },
                        "configuracion": {
                          "type": "boolean"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/sugerencias": {
      "get": {
        "summary": "üí° SUGERENCIAS CONTEXTUALES - Genera sugerencias basadas en historial",
        "description": "Genera sugerencias inteligentes basadas en el historial de interacciones de la sesi√≥n. Usa queries din√°micas para analizar patrones y recomendar acciones.",
        "operationId": "sugerencias",
        "tags": [
          "üß† Memoria Integrada"
        ],
        "security": [],
        "parameters": [
          {
            "name": "Session-ID",
            "in": "header",
            "description": "ID de sesi√≥n para obtener sugerencias contextuales",
            "schema": {
              "type": "string"
            }
          },
          {
            "name": "limite",
            "in": "query",
            "description": "N√∫mero m√°ximo de sugerencias",
            "schema": {
              "type": "integer",
              "default": 5
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Sugerencias generadas exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "sugerencias": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    },
                    "basadas_en_historial": {
                      "type": "boolean"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/contexto-inteligente": {
      "get": {
        "summary": "üß† CONTEXTO INTELIGENTE - Devuelve contexto interpretado filtrado",
        "description": "Devuelve contexto inteligente filtrado de la sesi√≥n usando queries din√°micas. Genera resumen sem√°ntico del contexto.",
        "operationId": "contextoInteligente",
        "tags": [
          "üß† Memoria Integrada"
        ],
        "security": [],
        "parameters": [
          {
            "name": "Session-ID",
            "in": "header",
            "description": "ID de sesi√≥n",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Contexto obtenido exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "contexto": {
                      "type": "object"
                    },
                    "resumen_semantico": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/memoria-global": {
      "get": {
        "summary": "üíæ MEMORIA GLOBAL - Deduplicaci√≥n multi-sesi√≥n",
        "description": "Consulta interacciones de m√∫ltiples sesiones con deduplicaci√≥n sem√°ntica. Usa queries din√°micas para filtrar y resumir.",
        "operationId": "memoriaGlobal",
        "tags": [
          "üß† Memoria Integrada"
        ],
        "security": [],
        "parameters": [
          {
            "name": "limite",
            "in": "query",
            "description": "N√∫mero m√°ximo de interacciones",
            "schema": {
              "type": "integer",
              "default": 20
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Memoria global obtenida",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "interacciones_globales": {
                      "type": "array"
                    },
                    "deduplicadas": {
                      "type": "boolean"
                    },
                    "total_sesiones": {
                      "type": "integer"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/diagnostico": {
      "get": {
        "summary": "üîç DIAGN√ìSTICO DE SESI√ìN - Analiza qu√© ocurri√≥ en una sesi√≥n",
        "description": "Analiza interacciones de una sesi√≥n espec√≠fica, detecta patrones de errores y genera diagn√≥stico con m√©tricas.",
        "operationId": "diagnostico",
        "tags": [
          "üß† Memoria Integrada"
        ],
        "security": [],
        "parameters": [
          {
            "name": "session_id",
            "in": "query",
            "description": "ID de sesi√≥n a diagnosticar",
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "Diagn√≥stico completado",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "diagnostico": {
                      "type": "object"
                    },
                    "metricas": {
                      "type": "object"
                    },
                    "patrones_detectados": {
                      "type": "array"
                    }
                  }
                },
                "examples": {
                  "custom_python_test": {
                    "summary": "Ejecutar snippet Python de prueba (ejemplo)",
                    "value": {
                      "test": "custom_python",
                      "code": "from services.redis_buffer_service import RedisBufferService\nr = RedisBufferService()\nprint(r._client.ping())"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/msearch": {
      "post": {
        "summary": "üîç AN√ÅLISIS SEM√ÅNTICO AVANZADO - Detecci√≥n de clases, funciones, duplicados y errores l√≥gicos",
        "description": "‚≠ê ENDPOINT ROBUSTO para an√°lisis sem√°ntico profundo de c√≥digo Python. Detecta clases, funciones, imports duplicados, problemas de indentaci√≥n, errores l√≥gicos y conflictos de nombres. Acepta archivo por ruta o contenido directo. ‚ú® B√öSQUEDA GLOBAL: Usar file_path='*' para buscar patrones en todos los archivos del proyecto. Formato din√°mico sin predefiniciones r√≠gidas.",
        "operationId": "msearch",
        "tags": [
          "üîç An√°lisis Sem√°ntico"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "properties": {
                  "file_path": {
                    "type": "string",
                    "description": "Ruta del archivo a analizar (Azure Blob o local). Usar '*' para b√∫squeda global en todos los archivos del proyecto.",
                    "example": "function_app.py"
                  },
                  "ruta": {
                    "type": "string",
                    "description": "Alias para file_path"
                  },
                  "path": {
                    "type": "string",
                    "description": "Alias para file_path"
                  },
                  "content": {
                    "type": "string",
                    "description": "Contenido directo del archivo a analizar"
                  },
                  "contenido": {
                    "type": "string",
                    "description": "Alias para content"
                  },
                  "search_type": {
                    "type": "string",
                    "enum": [
                      "all",
                      "classes",
                      "functions",
                      "imports",
                      "duplicates",
                      "indentation",
                      "logical_errors",
                      "syntax_errors"
                    ],
                    "default": "all",
                    "description": "Tipo de an√°lisis a realizar"
                  },
                  "tipo": {
                    "type": "string",
                    "description": "Alias para search_type"
                  },
                  "pattern": {
                    "type": "string",
                    "description": "Patr√≥n regex para filtrar resultados (opcional)",
                    "example": ".*Handler.*"
                  },
                  "patron": {
                    "type": "string",
                    "description": "Alias para pattern"
                  }
                },
                "additionalProperties": true,
                "examples": [
                  {
                    "file_path": "function_app.py",
                    "search_type": "all"
                  },
                  {
                    "file_path": "*",
                    "search_type": "all",
                    "pattern": "memoria.*10|interacciones.*19"
                  },
                  {
                    "content": "class MyClass:\n    def method(self):\n        pass",
                    "search_type": "classes"
                  },
                  {
                    "ruta": "endpoints/msearch.py",
                    "tipo": "functions",
                    "patron": ".*_http"
                  }
                ]
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "An√°lisis sem√°ntico completado exitosamente. Para b√∫squeda global (file_path='*'), retorna coincidencias de patr√≥n en todos los archivos.",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": true
                    },
                    "file_path": {
                      "type": "string",
                      "description": "Ruta del archivo analizado"
                    },
                    "analysis_type": {
                      "type": "string",
                      "description": "Tipo de an√°lisis realizado"
                    },
                    "pattern": {
                      "type": "string",
                      "description": "Patr√≥n utilizado para filtrar"
                    },
                    "matches": {
                      "type": "array",
                      "description": "Coincidencias encontradas (solo para b√∫squeda global con file_path='*')",
                      "items": {
                        "type": "object",
                        "properties": {
                          "file": {
                            "type": "string",
                            "description": "Archivo donde se encontr√≥ la coincidencia"
                          },
                          "line": {
                            "type": "integer",
                            "description": "N√∫mero de l√≠nea"
                          },
                          "content": {
                            "type": "string",
                            "description": "Contenido de la l√≠nea"
                          },
                          "match": {
                            "type": "string",
                            "description": "Patr√≥n que coincidi√≥"
                          }
                        }
                      }
                    },
                    "files_analyzed": {
                      "type": "array",
                      "description": "Lista de archivos analizados (solo para b√∫squeda global)",
                      "items": {
                        "type": "string"
                      }
                    },
                    "total_files": {
                      "type": "integer",
                      "description": "Total de archivos analizados (solo para b√∫squeda global)"
                    },
                    "files_with_matches": {
                      "type": "integer",
                      "description": "Archivos que contienen coincidencias (solo para b√∫squeda global)"
                    },
                    "results": {
                      "type": "object",
                      "description": "Resultados de an√°lisis sem√°ntico (solo para archivos individuales)",
                      "properties": {
                        "classes": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "name": {
                                "type": "string"
                              },
                              "line": {
                                "type": "integer"
                              },
                              "methods": {
                                "type": "array",
                                "items": {
                                  "type": "string"
                                }
                              },
                              "bases": {
                                "type": "array",
                                "items": {
                                  "type": "string"
                                }
                              },
                              "decorators": {
                                "type": "array",
                                "items": {
                                  "type": "string"
                                }
                              }
                            }
                          }
                        },
                        "functions": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "name": {
                                "type": "string"
                              },
                              "line": {
                                "type": "integer"
                              },
                              "args": {
                                "type": "array",
                                "items": {
                                  "type": "string"
                                }
                              },
                              "decorators": {
                                "type": "array",
                                "items": {
                                  "type": "string"
                                }
                              },
                              "is_async": {
                                "type": "boolean"
                              },
                              "docstring": {
                                "type": "string"
                              }
                            }
                          }
                        },
                        "imports": {
                          "type": "object",
                          "properties": {
                            "regular": {
                              "type": "array"
                            },
                            "from_imports": {
                              "type": "array"
                            },
                            "conflicts": {
                              "type": "array"
                            }
                          }
                        },
                        "duplicates": {
                          "type": "object",
                          "properties": {
                            "functions": {
                              "type": "array"
                            },
                            "classes": {
                              "type": "array"
                            }
                          }
                        },
                        "indentation_issues": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "line": {
                                "type": "integer"
                              },
                              "type": {
                                "type": "string"
                              },
                              "message": {
                                "type": "string"
                              },
                              "content": {
                                "type": "string"
                              }
                            }
                          }
                        },
                        "logical_errors": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "line": {
                                "type": "integer"
                              },
                              "type": {
                                "type": "string"
                              },
                              "message": {
                                "type": "string"
                              }
                            }
                          }
                        },
                        "syntax_errors": {
                          "type": "array",
                          "items": {
                            "type": "object",
                            "properties": {
                              "type": {
                                "type": "string"
                              },
                              "line": {
                                "type": "integer"
                              },
                              "message": {
                                "type": "string"
                              },
                              "text": {
                                "type": "string"
                              }
                            }
                          }
                        }
                      }
                    },
                    "statistics": {
                      "type": "object",
                      "properties": {
                        "total_lines": {
                          "type": "integer"
                        },
                        "classes_found": {
                          "type": "integer"
                        },
                        "functions_found": {
                          "type": "integer"
                        },
                        "imports_found": {
                          "type": "integer"
                        },
                        "issues_found": {
                          "type": "integer"
                        }
                      }
                    },
                    "run_id": {
                      "type": "string"
                    },
                    "timestamp": {
                      "type": "string",
                      "format": "date-time"
                    }
                  },
                  "required": [
                    "exito",
                    "results",
                    "statistics"
                  ]
                }
              }
            }
          },
          "400": {
            "description": "Solicitud inv√°lida o par√°metros faltantes",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string"
                    },
                    "campos_aceptados": {
                      "type": "array",
                      "items": {
                        "type": "string"
                      }
                    }
                  }
                }
              }
            }
          },
          "500": {
            "description": "Error interno del servidor",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string"
                    },
                    "error_type": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },

    "/api/indexar-memoria": {
      "post": {
        "operationId": "indexarMemoriaSematica",
        "summary": "Indexar documentos en memoria sem√°ntica",
        "description": "Indexa documentos en Azure AI Search usando Managed Identity.",
        "tags": [
          "üß† Memoria Sem√°ntica"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "documentos"
                ],
                "properties": {
                  "documentos": {
                    "type": "array",
                    "items": {
                      "type": "object",
                      "required": [
                        "id",
                        "agent_id",
                        "texto_semantico"
                      ],
                      "properties": {
                        "id": {
                          "type": "string"
                        },
                        "agent_id": {
                          "type": "string"
                        },
                        "session_id": {
                          "type": "string"
                        },
                        "endpoint": {
                          "type": "string"
                        },
                        "timestamp": {
                          "type": "string",
                          "format": "date-time"
                        },
                        "tipo": {
                          "type": "string"
                        },
                        "texto_semantico": {
                          "type": "string"
                        },
                        "vector": {
                          "type": "array",
                          "items": {
                            "type": "number"
                          }
                        },
                        "exito": {
                          "type": "boolean"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Indexaci√≥n exitosa",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean"
                    },
                    "documentos_subidos": {
                      "type": "integer"
                    },
                    "resultado": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/guardar-memoria": {
      "post": {
        "summary": "üß† GUARDAR EN MEMORIA - Almacenamiento intencional de contexto",
        "description": "Permite al agente guardar contenido expl√≠citamente en memoria vectorial. El agente decide QU√â es importante bas√°ndose en intenci√≥n sem√°ntica.\n\nCasos de uso:\n- Guardar res√∫menes de conversaciones largas\n- Almacenar decisiones importantes del usuario\n- Registrar configuraciones aplicadas\n- Documentar soluciones a problemas complejos\n\nNO usa heur√≠sticas autom√°ticas - el agente tiene control total.",
        "operationId": "guardarMemoria",
        "tags": [
          "üß† Memoria Sem√°ntica"
        ],
        "security": [],
        "requestBody": {
          "required": true,
          "content": {
            "application/json": {
              "schema": {
                "type": "object",
                "required": [
                  "contenido"
                ],
                "properties": {
                  "contenido": {
                    "type": "string",
                    "description": "Contenido a guardar en memoria vectorial",
                    "example": "Resumen: El usuario configur√≥ top_k=8 para mejorar b√∫squeda vectorial..."
                  },
                  "tipo": {
                    "type": "string",
                    "description": "Tipo de memoria",
                    "enum": [
                      "resumen_conversacion",
                      "decision_usuario",
                      "configuracion_aplicada",
                      "solucion_problema",
                      "memoria_manual"
                    ],
                    "default": "memoria_manual"
                  },
                  "session_id": {
                    "type": "string",
                    "description": "ID de sesi√≥n (opcional, se detecta autom√°ticamente)"
                  },
                  "agent_id": {
                    "type": "string",
                    "description": "ID del agente (opcional, se detecta autom√°ticamente)"
                  },
                  "metadata": {
                    "type": "object",
                    "description": "Metadata adicional",
                    "properties": {
                      "importancia": {
                        "type": "string",
                        "enum": [
                          "baja",
                          "media",
                          "alta"
                        ]
                      },
                      "fuente": {
                        "type": "string"
                      },
                      "tags": {
                        "type": "array",
                        "items": {
                          "type": "string"
                        }
                      }
                    }
                  }
                }
              },
              "examples": {
                "resumen": {
                  "summary": "Guardar resumen de conversaci√≥n",
                  "value": {
                    "contenido": "Resumen: Usuario solicit√≥ configurar top_k=8 en copiloto-semantico-func-us2. Se aplic√≥ exitosamente.",
                    "tipo": "resumen_conversacion",
                    "metadata": {
                      "importancia": "alta",
                      "fuente": "foundry"
                    }
                  }
                },
                "decision": {
                  "summary": "Guardar decisi√≥n del usuario",
                  "value": {
                    "contenido": "Decisi√≥n: Usuario prefiere usar Azure CLI en lugar de SDK para operaciones de storage",
                    "tipo": "decision_usuario",
                    "session_id": "assistant"
                  }
                }
              }
            }
          }
        },
        "responses": {
          "200": {
            "description": "Contenido guardado exitosamente en memoria",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": true
                    },
                    "mensaje": {
                      "type": "string",
                      "example": "Contenido guardado en memoria vectorial"
                    },
                    "detalles": {
                      "type": "object",
                      "properties": {
                        "longitud": {
                          "type": "integer",
                          "description": "Longitud del contenido guardado"
                        },
                        "tipo": {
                          "type": "string"
                        },
                        "session_id": {
                          "type": "string"
                        },
                        "timestamp": {
                          "type": "string",
                          "format": "date-time"
                        }
                      }
                    }
                  }
                }
              }
            }
          },
          "400": {
            "description": "Par√°metros inv√°lidos",
            "content": {
              "application/json": {
                "schema": {
                  "type": "object",
                  "properties": {
                    "exito": {
                      "type": "boolean",
                      "example": false
                    },
                    "error": {
                      "type": "string"
                    },
                    "ejemplo": {
                      "type": "object"
                    }
                  }
                }
              }
            }
          }
        }
      }
    },
    "/api/redis-cache-monitor": {
      "get": {
        "operationId": "getRedisCacheMonitor",
        "summary": "Obtiene m√©tricas detalladas de la estrategia de cache dual Redis",
        "description": "Retorna estad√≠sticas espec√≠ficas de la estrategia de cache dual (sesi√≥n + global), incluyendo conteos por patr√≥n, hit ratio, issues detectados y recomendaciones. El sistema implementa una estrategia de cache en dos niveles: Cache de Sesi√≥n (llm:{agent}:session:{session_id}:model:{model}:msg:{hash}) y Cache Global (llm:{agent}:model:{model}:msg:{hash}) cross-sesi√≥n. Los agentes pueden usar este endpoint para verificar que Redis est√° funcionando, monitorear hit ratio de cache, detectar problemas autom√°ticamente y tomar decisiones basadas en m√©tricas.",
        "tags": [
          "Redis Cache",
          "Monitoring"
        ],
        "security": [],
        "responses": {
          "200": {
            "description": "M√©tricas de cache obtenidas exitosamente",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RedisCacheMonitorResponse"
                },
                "examples": {
                  "healthy": {
                    "summary": "Cache funcionando correctamente",
                    "value": {
                      "cache_strategy": "dual_cache_session_global",
                      "redis_enabled": true,
                      "timestamp": "2025-12-05T20:30:45.123Z",
                      "key_counts": {
                        "llm_session_keys": 125,
                        "llm_global_keys": 89,
                        "llm_auto_sessions": 7,
                        "memoria_keys": 23,
                        "thread_keys": 15
                      },
                      "cache_effectiveness": {
                        "hit_ratio": "74.2%",
                        "hits": 892,
                        "misses": 310,
                        "total_operations": 1202
                      },
                      "issues": [],
                      "issues_count": 0,
                      "recommendations": [
                        "Cache dual funcionando correctamente",
                        "Hit ratio √≥ptimo: 74.2%"
                      ]
                    }
                  },
                  "with_issues": {
                    "summary": "Cache con problemas detectados",
                    "value": {
                      "cache_strategy": "dual_cache_session_global",
                      "redis_enabled": true,
                      "timestamp": "2025-12-05T20:30:45.123Z",
                      "key_counts": {
                        "llm_session_keys": 450,
                        "llm_global_keys": 0,
                        "llm_auto_sessions": 210
                      },
                      "cache_effectiveness": {
                        "hit_ratio": "22.5%",
                        "hits": 45,
                        "misses": 155,
                        "total_operations": 200
                      },
                      "issues": [
                        "Cache global no est√° siendo escrita (solo session cache)",
                        "Muchas sesiones auto-generadas: 210",
                        "Hit ratio bajo: 22.5%"
                      ],
                      "issues_count": 3,
                      "recommendations": [
                        "Verificar escritura en cache global",
                        "Revisar generaci√≥n de session_id en agentes"
                      ]
                    }
                  }
                }
              }
            }
          },
          "503": {
            "description": "Redis cache est√° deshabilitado",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/ErrorResponse"
                },
                "example": {
                  "error": "Redis cache disabled - check REDIS_KEY configuration"
                }
              }
            }
          }
        }
      }
    },
    "/api/redis-cache-health": {
      "get": {
        "operationId": "getRedisCacheHealth",
        "summary": "Health check r√°pido del sistema de cache Redis",
        "description": "Verificaci√≥n r√°pida del estado de Redis cache. Incluye ping b√°sico, conteo de claves LLM y detecci√≥n de sesiones auto-generadas. Estados posibles: healthy (Redis responde y tiene datos cacheados), no_data (Redis responde pero sin datos a√∫n), unhealthy (Redis no responde al ping), disabled (Redis cache est√° deshabilitado), error (Error inesperado).",
        "tags": [
          "Redis Cache",
          "Health"
        ],
        "security": [],
        "responses": {
          "200": {
            "description": "Estado de health obtenido",
            "content": {
              "application/json": {
                "schema": {
                  "$ref": "#/components/schemas/RedisCacheHealthResponse"
                },
                "examples": {
                  "healthy": {
                    "summary": "Cache saludable",
                    "value": {
                      "status": "healthy",
                      "redis_enabled": true,
                      "timestamp": "2025-12-05T20:30:45.123Z",
                      "message": "Cache activa y con datos",
                      "checks": {
                        "ping": true,
                        "has_llm_keys": true,
                        "llm_keys_count": 80,
                        "auto_sessions_count": 5
                      }
                    }
                  },
                  "no_data": {
                    "summary": "Redis funciona pero sin datos",
                    "value": {
                      "status": "no_data",
                      "redis_enabled": true,
                      "timestamp": "2025-12-05T20:30:45.123Z",
                      "message": "Redis responde, sin datos cacheados a√∫n",
                      "checks": {
                        "ping": true,
                        "has_llm_keys": false,
                        "llm_keys_count": 0,
                        "auto_sessions_count": 0
                      }
                    }
                  },
                  "disabled": {
                    "summary": "Redis deshabilitado",
                    "value": {
                      "status": "disabled",
                      "redis_enabled": false,
                      "timestamp": "2025-12-05T20:30:45.123Z",
                      "message": "Redis cache is disabled"
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "tags": [
    {
      "name": "Azure Storage",
      "description": "Operaciones de Azure Blob Storage incluyendo descarga robusta de archivos"
    },
    {
      "name": "üöÄ Universal CLI Executor",
      "description": "Ejecutor universal que acepta cualquier tipo de comando sin restricciones"
    },
    {
      "name": "Diagn√≥stico",
      "description": "Diagn√≥stico y monitoreo de recursos"
    },
    {
      "name": "Azure Deployment",
      "description": "Deployment de recursos con ARM templates"
    },
    {
      "name": "Azure Configuration",
      "description": "Configuraci√≥n de recursos Azure"
    },
    {
      "name": "Testing",
      "description": "Pruebas y validaci√≥n de endpoints"
    },
    {
      "name": "Internal",
      "description": "Operaciones internas de la Function App"
    },
    {
      "name": "üß† Memoria Integrada",
      "description": "Sistema autom√°tico de memoria con consulta previa y guardado de interacciones en Cosmos DB"
    },
    {
      "name": "üß† Memoria Sem√°ntica",
      "description": "B√∫squeda e indexaci√≥n sem√°ntica con Azure AI Search usando Managed Identity"
    },
    {
      "name": "Local Storage",
      "description": "Operaciones en el filesystem local del contenedor"
    },
    {
      "name": "Autocorrecci√≥n",
      "description": "Endpoints relacionados con sugerencias, revisi√≥n y promoci√≥n de correcciones automatizadas o manuales."
    },
    {
      "name": "Bridge",
      "description": "Endpoints tolerantes para agentes problem√°ticos"
    },
    {
      "name": "üöÄ Despliegues Robustos",
      "description": "Sistema robusto y sem√°ntico para gesti√≥n completa de despliegues. Acepta cualquier formato, nunca falla, siempre retorna √©xito=true para compatibilidad con agentes."
    },
    {
      "name": "üîç An√°lisis Sem√°ntico",
      "description": "An√°lisis sem√°ntico avanzado de c√≥digo Python: detecci√≥n de clases, funciones, duplicados, errores l√≥gicos, problemas de indentaci√≥n y conflictos de imports"
    },
    {
      "name": "Redis Cache",
      "description": "Monitoreo y health check del sistema de cache Redis dual (sesi√≥n + global) para optimizaci√≥n de rendimiento"
    }
  ],
  "components": {
    "schemas": {
      "ErrorEnvelope": {
        "type": "object",
        "properties": {
          "ok": {
            "type": "boolean",
            "enum": [
              false
            ]
          },
          "error_code": {
            "type": "string"
          },
          "status": {
            "type": "integer",
            "nullable": true
          },
          "cause": {
            "type": "string"
          },
          "hint": {
            "type": "string",
            "nullable": true
          },
          "next_steps": {
            "type": "array",
            "items": {
              "type": "string"
            }
          },
          "trace": {
            "type": "string",
            "nullable": true
          }
        },
        "required": [
          "ok",
          "error_code"
        ]
      },
      "MoverArchivoRequest": {
        "type": "object",
        "properties": {
          "origen": {
            "type": "string",
            "description": "Ruta del archivo de origen"
          },
          "destino": {
            "type": "string",
            "description": "Ruta del archivo de destino"
          },
          "overwrite": {
            "type": "boolean",
            "default": false,
            "description": "Sobrescribir si existe"
          }
        },
        "required": [
          "origen",
          "destino"
        ]
      },
      "CopiarArchivoRequest": {
        "type": "object",
        "properties": {
          "origen": {
            "type": "string",
            "description": "Ruta del archivo de origen"
          },
          "destino": {
            "type": "string",
            "description": "Ruta del archivo de destino"
          },
          "overwrite": {
            "type": "boolean",
            "default": false,
            "description": "Sobrescribir si existe"
          }
        },
        "required": [
          "origen",
          "destino"
        ]
      },
      "PrepararScriptRequest": {
        "type": "object",
        "required": [
          "ruta"
        ],
        "properties": {
          "ruta": {
            "type": "string",
            "description": "Ruta local del script a preparar"
          },
          "tipo": {
            "type": "string",
            "description": "Tipo de script (opcional)"
          },
          "opciones": {
            "type": "object",
            "description": "Opciones adicionales (opcional)"
          },
          "metadata": {
            "type": "object",
            "description": "Metadata extra (opcional)"
          }
        }
      },
      "GestionarDespliegueRequest": {
        "type": "object",
        "properties": {
          "accion": {
            "type": "string",
            "enum": [
              "deploy",
              "rollback",
              "status",
              "validate"
            ],
            "description": "Acci√≥n a realizar"
          },
          "ambiente": {
            "type": "string",
            "enum": [
              "dev",
              "staging",
              "prod"
            ],
            "description": "Ambiente de despliegue"
          },
          "version": {
            "type": "string",
            "description": "Versi√≥n a desplegar o rollback"
          },
          "configuracion": {
            "type": "object",
            "description": "Configuraci√≥n adicional del despliegue"
          }
        },
        "required": [
          "accion",
          "ambiente"
        ]
      },
      "RespuestaGestionarDespliegueRobusta": {
        "type": "object",
        "description": "Respuesta unificada del sistema robusto de gesti√≥n de despliegues",
        "properties": {
          "exito": {
            "type": "boolean",
            "enum": [
              true
            ],
            "description": "SIEMPRE true para compatibilidad con agentes"
          },
          "accion_ejecutada": {
            "type": "string",
            "enum": [
              "detectar",
              "preparar",
              "desplegar",
              "rollback",
              "status",
              "validate",
              "error_recovery"
            ],
            "description": "Acci√≥n que se ejecut√≥ realmente"
          },
          "alias_usado": {
            "type": "string",
            "nullable": true,
            "description": "Alias o sin√≥nimo detectado en el payload"
          },
          "resultado": {
            "type": "object",
            "additionalProperties": true,
            "description": "Resultado espec√≠fico de la acci√≥n ejecutada",
            "properties": {
              "tipo": {
                "type": "string",
                "description": "Tipo de resultado"
              },
              "mensaje": {
                "type": "string",
                "description": "Mensaje descriptivo"
              },
              "comandos_sugeridos": {
                "type": "array",
                "items": {
                  "type": "string"
                },
                "description": "Comandos sugeridos para ejecutar"
              },
              "hash_funcion": {
                "type": "string",
                "description": "Hash de la funci√≥n actual (para detectar)"
              },
              "proximo_tag": {
                "type": "string",
                "description": "Pr√≥ximo tag sugerido"
              },
              "script_content": {
                "type": "string",
                "description": "Contenido del script generado (para preparar)"
              }
            }
          },
          "metadata": {
            "type": "object",
            "properties": {
              "run_id": {
                "type": "string",
                "description": "ID √∫nico de la ejecuci√≥n"
              },
              "endpoint": {
                "type": "string",
                "description": "Endpoint que proces√≥ la petici√≥n"
              },
              "timestamp": {
                "type": "string",
                "format": "date-time",
                "description": "Timestamp de la ejecuci√≥n"
              },
              "version_sistema": {
                "type": "string",
                "description": "Versi√≥n del sistema robusto"
              }
            }
          },
          "proximas_acciones": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Sugerencias de pr√≥ximos pasos"
          }
        },
        "required": [
          "exito",
          "accion_ejecutada",
          "resultado"
        ]
      },
      "Error": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string"
          },
          "message": {
            "type": "string"
          },
          "code": {
            "type": "integer"
          }
        },
        "required": [
          "error"
        ]
      },
      "RedisCacheMonitorResponse": {
        "type": "object",
        "properties": {
          "cache_strategy": {
            "type": "string",
            "example": "dual_cache_session_global",
            "description": "Estrategia de cache implementada"
          },
          "redis_enabled": {
            "type": "boolean",
            "description": "Si Redis est√° habilitado"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "key_counts": {
            "type": "object",
            "additionalProperties": {
              "oneOf": [
                { "type": "integer" },
                { "type": "string" }
              ]
            },
            "example": {
              "llm_session_keys": 42,
              "llm_global_keys": 38,
              "llm_auto_sessions": 5,
              "memoria_keys": 12
            }
          },
          "total_llm_keys": {
            "type": "integer",
            "example": 80,
            "description": "Conteo total de claves LLM (sesi√≥n + global)"
          },
          "session_vs_global_ratio": {
            "type": "string",
            "example": "42:38",
            "description": "Proporci√≥n de claves de sesi√≥n vs global"
          },
          "cache_effectiveness": {
            "$ref": "#/components/schemas/CacheEffectiveness"
          },
          "sample_keys": {
            "type": "object",
            "additionalProperties": {
              "type": "array",
              "items": { "type": "string" }
            },
            "description": "Muestra de claves encontradas por patr√≥n",
            "example": {
              "llm_session_keys": ["llm:agent:session:sess-1:model:gpt-4o-mini:msg:abcd1234"],
              "llm_global_keys": ["llm:agent:model:gpt-4o-mini:msg:abcd1234"]
            }
          },
          "ttl_samples": {
            "type": "object",
            "additionalProperties": {
              "oneOf": [
                { "type": "integer" },
                { "type": "string" }
              ]
            },
            "description": "TTLs de claves de ejemplo",
            "example": {
              "llm:agent:session:sess-1:model:gpt-4o-mini:msg:abcd1234": 5340,
              "llm:agent:model:gpt-4o-mini:msg:abcd1234": 82800
            }
          },
          "redis_stats": {
            "type": "object",
            "properties": {
              "used_memory": { "type": "string", "example": "12.5M" },
              "dbsize": { "oneOf": [ { "type": "integer" }, { "type": "string" } ], "example": 1520 },
              "connected_clients": { "type": "integer", "example": 12 },
              "failure_streak": { "type": "integer", "example": 0 }
            },
            "description": "Estad√≠sticas b√°sicas reportadas por Redis"
          },
          "issues": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "example": [
              "Hit ratio bajo: 25.0%",
              "Muchas sesiones auto-generadas: 150"
            ]
          },
          "issues_count": {
            "type": "integer",
            "example": 2
          },
          "recommendations": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "example": [
              "Cache dual activa: session + global keys",
              "Hit ratio objetivo: >60% (actual: 25.0%)"
            ]
          }
        }
      },
      "RedisCacheHealthResponse": {
        "type": "object",
        "properties": {
          "status": {
            "type": "string",
            "enum": ["healthy", "unhealthy", "disabled", "no_data", "error", "unknown"],
            "example": "healthy"
          },
          "redis_enabled": {
            "type": "boolean"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          },
          "message": {
            "type": "string",
            "example": "Cache activa y con datos"
          },
          "checks": {
            "$ref": "#/components/schemas/HealthChecks"
          },
          "error": {
            "type": "string",
            "nullable": true,
            "description": "Solo presente si status=error"
          }
        }
      },
      "CacheEffectiveness": {
        "type": "object",
        "properties": {
          "hit_ratio": {
            "type": "string",
            "example": "64.7%"
          },
          "hits": {
            "type": "integer",
            "example": 124
          },
          "misses": {
            "type": "integer",
            "example": 68
          },
          "total_operations": {
            "type": "integer",
            "example": 192
          }
        }
      },
      "HealthChecks": {
        "type": "object",
        "properties": {
          "ping": {
            "type": "boolean",
            "example": true
          },
          "has_llm_keys": {
            "type": "boolean",
            "example": true
          },
          "llm_keys_count": {
            "type": "integer",
            "example": 80
          },
          "auto_sessions_count": {
            "type": "integer",
            "example": 5
          }
        }
      },
      "ErrorResponse": {
        "type": "object",
        "properties": {
          "error": {
            "type": "string",
            "example": "Redis cache disabled"
          }
        }
      },
      "ModelDeploymentResponse": {
        "type": "object",
        "title": "Model Deployment Response",
        "description": "Response structure for AI model deployment operations",
        "properties": {
          "ok": {
            "type": "boolean",
            "description": "Overall success status"
          },
          "action": {
            "type": "string",
            "enum": ["deployModels"],
            "description": "Type of deployment action"
          },
          "models_deployed": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Models successfully deployed"
          },
          "already_active": {
            "type": "array",
            "items": {
              "type": "string"
            },
            "description": "Models that were already active"
          },
          "failed": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string"
                },
                "error": {
                  "type": "string"
                },
                "intent": {
                  "type": "string"
                }
              }
            },
            "description": "Models that failed to deploy"
          },
          "summary": {
            "type": "object",
            "properties": {
              "total_requested": {
                "type": "integer"
              },
              "deployed": {
                "type": "integer"
              },
              "already_active": {
                "type": "integer"
              },
              "failed": {
                "type": "integer"
              }
            }
          },
          "deployment_details": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "model": {
                  "type": "string"
                },
                "intent": {
                  "type": "string"
                },
                "agent": {
                  "type": "string"
                },
                "status": {
                  "type": "string",
                  "enum": ["deployed", "already_active"]
                },
                "endpoint": {
                  "type": "string"
                },
                "project_id": {
                  "type": "string"
                },
                "deployment_time": {
                  "type": "string",
                  "format": "date-time"
                }
              }
            }
          },
          "foundry_endpoint": {
            "type": "string",
            "description": "Main Foundry endpoint URL"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          }
        },
        "required": ["ok", "action", "models_deployed", "already_active", "failed", "summary"]
      }
    }
  }
}

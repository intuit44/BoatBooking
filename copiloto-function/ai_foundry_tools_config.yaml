# Configuración de herramientas y agentes para Foundry

tools:
  - name: azure_cli_executor
    type: http
    config:
      base_url: https://copiloto-semantico-func-us2.azurewebsites.net
      endpoints:
        - path: /api/ejecutar-cli
          method: POST
          description: Ejecuta comandos Azure CLI
          parameters:
            comando:
              type: string
              required: true
              description: Comando a ejecutar (sin 'az' al inicio)

        - path: /api/status
          method: GET
          description: Verifica el estado del sistema

        - path: /api/listar-blobs
          method: GET
          description: Lista archivos en blob storage
          parameters:
            prefix:
              type: string
              required: false
              description: Prefijo para filtrar archivos

        - path: /api/copiloto
          method: POST
          description: Router semántico principal (usa memoria y decide la acción adecuada)
          parameters:
            mensaje:
              type: string
              required: false
              description: Mensaje natural o intención a resolver
            consulta:
              type: string
              required: false
              description: Consulta alternativa (si no se usa "mensaje")
            session_id:
              type: string
              required: false
              description: ID de sesión para mantener contexto

        - path: /api/diagnostico-recursos
          method: GET
          description: Diagnóstico completo de recursos Azure
          parameters:
            metricas:
              type: boolean
              required: false
              description: Incluir métricas de rendimiento
            costos:
              type: boolean
              required: false
              description: Incluir análisis de costos
            recurso:
              type: string
              required: false
              description: Recurso específico a diagnosticar

        - path: /api/crear-contenedor
          method: POST
          description: Crear contenedor en Blob Storage
          parameters:
            nombre:
              type: string
              required: true
              description: Nombre del contenedor (3-63 chars, minúsculas)
            publico:
              type: boolean
              required: false
              description: Si el contenedor será de acceso público
            metadata:
              type: object
              required: false
              description: Metadata adicional del contenedor

  - name: autocorrector_agent
    type: http
    config:
      base_url: https://copiloto-semantico-func-us2.azurewebsites.net
      endpoints:
        - path: /api/autocorregir
          method: POST
          description: Registrar una corrección propuesta por un agente AI
          headers:
            X-Agent-Auth:
              type: string
              required: true
              default: COPILOT-AGENT
          parameters:
            accion:
              type: string
              required: true
            target:
              type: string
              required: true
            propuesta:
              type: string
              required: true
            tipo:
              type: string
              required: true
            detonante:
              type: string
              required: false
              default: "manual"
            origen:
              type: string
              required: false
              default: "AI Agent"
        - path: /api/revisar-correcciones
          method: GET
          description: Ver todas las correcciones pendientes registradas

  - name: fix_promoter
    type: http
    config:
      base_url: https://copiloto-semantico-func-us2.azurewebsites.net
      endpoints:
        - path: /api/revisar-correcciones
          method: GET
          description: Correcciones pendientes
        
        - path: /api/promover
          method: POST
          description: Dispara ejecución del promotor
        
        - path: /api/rollback
          method: POST
          description: Revertir una corrección aplicada
      pipeline:
      - if: "hay correcciones pendientes && prioridad >= 9 && validado == true"
        then: call fix_promoter:/api/promover

agents:
  - name: supervisor_de_operaciones
    role: "Supervisor de Operaciones Azure"
    description: >
      Agente supervisor responsable de analizar, diagnosticar y sugerir pasos antes de ejecutar acciones.
      Prioriza la evaluación y las recomendaciones sobre la ejecución inmediata.
    modo: "suggestive-first"
    capabilities:
      diagnosticar:
        tool: azure_cli_executor:/api/diagnostico-recursos
        description: "Analiza estado de recursos Azure"
      sugerir:
        tool: autocorrector_agent:/api/revisar-correcciones
        description: "Revisa correcciones pendientes y sugiere acciones"
      validar:
        tool: autocorrector_agent:/api/revisar-correcciones
        description: "Valida que las correcciones tengan pruebas unitarias e integración"
      registrar:
        tool: azure_cli_executor:/api/status
        description: "Registrar en logs internos el estado antes y después de cada decisión"
      ejecutar_condicional:
        tool: fix_promoter:/api/promover
        description: "Ejecuta correcciones solo si cumplen criterios"
      revertir:
        tool: fix_promoter:/api/rollback
        description: "Rollback automático si falla la ejecución"
    policies:
      - rule: "Siempre entregar Diagnóstico + Pasos sugeridos + Comando propuesto"
      - rule: "Solo ejecutar si se cumplen criterios de validación (prioridad alta, correcciones críticas)"
      - rule: "Documentar todas las decisiones y justificaciones"
      - rule: "Validar pruebas unitarias e integración antes de ejecutar"
      - rule: "Registrar estado antes y después de cada acción"
      - rule: "Rollback automático si la ejecución falla"
      - rule: "Nunca ejecutar sin análisis previo completo"
    workflow:
      - step: "registrar"
        tool: azure_cli_executor:/api/status
        condition: "always"
        description: "Log estado inicial"
      - step: "diagnosticar"
        tool: azure_cli_executor:/api/diagnostico-recursos
        condition: "always"
        description: "Análisis completo de recursos"
      - step: "sugerir"
        tool: autocorrector_agent:/api/revisar-correcciones
        condition: "if diagnostico shows issues"
        description: "Generar propuestas de corrección"
      - step: "validar"
        tool: autocorrector_agent:/api/revisar-correcciones
        condition: "if sugerir shows fixes with missing validations"
        description: "Verificar pruebas unitarias e integración"
      - step: "ejecutar_condicional"
        tool: fix_promoter:/api/promover
        condition: "if priority >= 8 AND validated == true AND tests_passed == true"
        description: "Ejecutar solo si cumple todos los criterios"
      - step: "registrar"
        tool: azure_cli_executor:/api/status
        condition: "after execution"
        description: "Log estado post-ejecución"
      - step: "revertir"
        tool: fix_promoter:/api/rollback
        condition: "if execution failed OR validation failed post-execution"
        description: "Rollback automático en caso de fallo"
    context:
      environment: "production"
      risk_tolerance: "low"
      approval_required: true

mcpServers:
  redis-cached-chat:
    command: python
    args: ["mcp_redis_wrapper_server.py"]
    env:
      MCP_TRANSPORT: "http"
      MCP_HOST: "0.0.0.0"
      MCP_PORT: "8000"
    description: "Chat con cache Redis para respuestas LLM rápidas"

  redis-diagnostics:
    command: python
    args: ["mcp_redis_diagnostic_server.py"]
    env:
      MCP_TRANSPORT: "http"
      MCP_HOST: "0.0.0.0"
      MCP_PORT: "8001"
      FUNCTION_APP_URL: "https://copiloto-semantico-func-us2.azurewebsites.net"
    description: "Diagnóstico y monitoreo de Redis Cache (solo para debugging)"

@app.function_name(name="probar_endpoint_http")
@app.route(route="probar-endpoint", methods=["POST", "GET"], auth_level=func.AuthLevel.ANONYMOUS)
def probar_endpoint_http(req: func.HttpRequest) -> func.HttpResponse:
    """Prueba endpoints normalizando sufijo -http y analizando su funcionamiento"""
    try:
        endpoint = req.params.get("endpoint", "")
        method = req.params.get("method", "GET").upper()

        if req.method == "POST":
            try:
                body = req.get_json()
                endpoint = body.get("endpoint", endpoint)
                method = body.get("method", method)
                params = body.get("params", {})
                data = body.get("data", {})
            except:
                params = {}
                data = {}
        else:
            params = dict(req.params)
            params.pop("endpoint", None)
            params.pop("method", None)
            data = {}

        if not endpoint:
            return func.HttpResponse(
                json.dumps({
                    "exito": False,
                    "error": "Parámetro 'endpoint' requerido",
                    "timestamp": datetime.now().isoformat()
                }, ensure_ascii=False),
                mimetype="application/json",
                status_code=200
            )

        # Normalizar: intentar con y sin sufijo -http
        endpoints_a_probar = [endpoint]
        if endpoint.endswith("-http"):
            endpoints_a_probar.append(endpoint[:-5])  # Sin -http
        else:
            endpoints_a_probar.append(endpoint + "-http")  # Con -http

        resultado_final = None
        intentos = []

        for ep in endpoints_a_probar:
            resultado = invocar_endpoint_directo(
                endpoint=ep,
                method=method,
                params=params if method == "GET" else None,
                body=data if method in ["POST", "PUT", "PATCH"] else None
            )
            
            intentos.append({
                "endpoint": ep,
                "exito": resultado.get("exito"),
                "status_code": resultado.get("status_code")
            })

            if resultado.get("status_code") != 404:
                resultado_final = resultado
                resultado_final["endpoint_usado"] = ep
                resultado_final["endpoint_original"] = endpoint
                resultado_final["normalizado"] = ep != endpoint
                break

        if not resultado_final:
            resultado_final = {
                "exito": False,
                "error": f"Endpoint '{endpoint}' no encontrado en ninguna variante",
                "intentos": intentos,
                "timestamp": datetime.now().isoformat()
            }

        return func.HttpResponse(
            json.dumps(resultado_final, indent=2, ensure_ascii=False),
            mimetype="application/json",
            status_code=200
        )

    except Exception as e:
        logging.exception("probar_endpoint_http failed")
        return func.HttpResponse(
            json.dumps({
                "exito": False,
                "error": str(e),
                "tipo_error": type(e).__name__,
                "timestamp": datetime.now().isoformat()
            }, ensure_ascii=False),
            mimetype="application/json",
            status_code=200
        )


def invocar_endpoint_directo_seguro(endpoint: str, method: str = "GET", body: Optional[dict] = None, params: Optional[dict] = None) -> dict:

import React, { useState } from 'react';
import {
  View,
  StyleSheet,
  ScrollView,
  Alert,
} from 'react-native';
import {
  Text,
  Card,
  Title,
  Paragraph,
  Button,
  TextInput,
  Surface,
  Divider,
  Chip,
} from 'react-native-paper';
import { Calendar } from 'react-native-calendars';
import { AppDispatch, RootState, } from '../../store/store';
import { createBooking } from '../../store/slices/bookingsSlice';
import { Boat } from '../../store/slices/boatsSlice';
import { useAppDispatch, useAppSelector } from '../../store/hooks';


interface Props {
  navigation: any;
  route: any;
}

const TIME_SLOTS = [
  '08:00', '09:00', '10:00', '11:00', '12:00',
  '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'
];

export function BookingScreen({ navigation, route }: Props) {
  const { boat }: { boat: Boat } = route.params;

  const [selectedDate, setSelectedDate] = useState('');
  const [startTime, setStartTime] = useState('');
  const [endTime, setEndTime] = useState('');
  const [guests, setGuests] = useState('1');
  const [specialRequests, setSpecialRequests] = useState('');
  const [contactInfo, setContactInfo] = useState({
    name: '',
    phone: '',
    email: '',
  });

  const dispatch = useAppDispatch();
  const { user } = useAppSelector((state: RootState) => state.auth);
  const { isLoading } = useAppSelector((state: RootState) => state.bookings);

  React.useEffect(() => {
    if (user) {
      setContactInfo({
        name: user.name,
        phone: user?.phone || '',
        email: user.email,
      });
    }
  }, [user]);

  const calculateTotalHours = () => {
    if (!startTime || !endTime) return 0;
    const start = parseInt(startTime.split(':')[0]);
    const end = parseInt(endTime.split(':')[0]);
    return Math.max(0, end - start);
  };

  const calculateTotalPrice = () => {
    const hours = calculateTotalHours();
    return hours * boat.pricePerHour;
  };

  const validateBooking = () => {
    if (!selectedDate) {
      Alert.alert('Error', 'Por favor selecciona una fecha');
      return false;
    }

    if (!startTime || !endTime) {
      Alert.alert('Error', 'Por favor selecciona horario de inicio y fin');
      return false;
    }

    if (calculateTotalHours() <= 0) {
      Alert.alert('Error', 'La hora de fin debe ser posterior a la de inicio');
      return false;
    }

    if (!guests || parseInt(guests) < 1 || parseInt(guests) > boat.capacity) {
      Alert.alert('Error', `N√∫mero de hu√©spedes debe estar entre 1 y ${boat.capacity}`);
      return false;
    }

    if (!contactInfo.name || !contactInfo.phone || !contactInfo.email) {
      Alert.alert('Error', 'Por favor completa toda la informaci√≥n de contacto');
      return false;
    }

    return true;
  };

  const handleContinueToPayment = async () => {
    if (!validateBooking()) return;

    const bookingData = {
      boatId: boat.id,
      boatName: boat.name,
      boatImage: boat.images[0],
      userId: user?.id || '',
      startDate: selectedDate,
      endDate: selectedDate,
      startTime,
      endTime,
      totalHours: calculateTotalHours(),
      pricePerHour: boat.pricePerHour,
      totalPrice: calculateTotalPrice(),
      currency: 'USD' as const,
      paymentMethod: 'zelle' as const,
      paymentStatus: 'pending' as const,
      bookingStatus: 'pending' as const,
      guests: parseInt(guests),
      specialRequests,
      contactInfo,
      marina: {
        name: boat.location.marina,
        address: `${boat.location.marina}, ${boat.location.state}`,
        coordinates: boat.location.coordinates,
      },
    };

    try {
      const result = await dispatch(createBooking(bookingData)).unwrap();
      navigation.navigate('Payment', { booking: result });
    } catch (error) {
      Alert.alert('Error', 'No se pudo crear la reserva');
    }
  };

  const markedDates = {
    [selectedDate]: {
      selected: true,
      selectedColor: '#0066CC',
    },
  };

  return (
    <ScrollView style={styles.container} showsVerticalScrollIndicator={false}>
      {/* Boat Summary */}
      <Card style={styles.boatSummary}>
        <Card.Content>
          <View style={styles.boatHeader}>
            <View style={styles.boatInfo}>
              <Title style={styles.boatName}>{boat.name}</Title>
              <Text style={styles.boatLocation}>
                üìç {boat.location.marina}, {boat.location.state}
              </Text>
            </View>
            <View style={styles.priceInfo}>
              <Text style={styles.price}>${boat.pricePerHour}</Text>
              <Text style={styles.priceUnit}>por hora</Text>
            </View>
          </View>
        </Card.Content>
      </Card>

      {/* Date Selection */}
      <Card style={styles.section}>
        <Card.Content>
          <Title style={styles.sectionTitle}>üìÖ Seleccionar Fecha</Title>
          <Calendar
            onDayPress={(day) => setSelectedDate(day.dateString)}
            markedDates={markedDates}
            minDate={new Date().toISOString().split('T')[0]}
            theme={{
              selectedDayBackgroundColor: '#0066CC',
              todayTextColor: '#0066CC',
              arrowColor: '#0066CC',
            }}
          />
        </Card.Content>
      </Card>

      {/* Time Selection */}
      <Card style={styles.section}>
        <Card.Content>
          <Title style={styles.sectionTitle}>üïê Horario</Title>

          <Text style={styles.timeLabel}>Hora de inicio</Text>
          <View style={styles.timeSlots}>
            {TIME_SLOTS.map((time) => (
              <Chip
                key={`start-${time}`}
                selected={startTime === time}
                onPress={() => setStartTime(time)}
                style={styles.timeChip}
              >
                {time}
              </Chip>
            ))}
          </View>

          <Text style={styles.timeLabel}>Hora de fin</Text>
          <View style={styles.timeSlots}>
            {TIME_SLOTS.map((time) => (
              <Chip
                key={`end-${time}`}
                selected={endTime === time}
                onPress={() => setEndTime(time)}
                style={styles.timeChip}
                disabled={!startTime || time <= startTime}
              >
                {time}
              </Chip>
            ))}
          </View>

          {calculateTotalHours() > 0 && (
            <Surface style={styles.durationInfo}>
              <Text style={styles.durationText}>
                ‚è±Ô∏è Duraci√≥n: {calculateTotalHours()} horas
              </Text>
            </Surface>
          )}
        </Card.Content>
      </Card>

      {/* Guests */}
      <Card style={styles.section}>
        <Card.Content>
          <Title style={styles.sectionTitle}>üë• N√∫mero de Hu√©spedes</Title>
          <TextInput
            label={`Hu√©spedes (m√°x. ${boat.capacity})`}
            value={guests}
            onChangeText={setGuests}
            keyboardType="numeric"
            mode="outlined"
            style={styles.input}
          />
        </Card.Content>
      </Card>

      {/* Contact Information */}
      <Card style={styles.section}>
        <Card.Content>
          <Title style={styles.sectionTitle}>üìû Informaci√≥n de Contacto</Title>

          <TextInput
            label="Nombre completo"
            value={contactInfo.name}
            onChangeText={(text) => setContactInfo({ ...contactInfo, name: text })}
            mode="outlined"
            style={styles.input}
          />

          <TextInput
            label="Tel√©fono"
            value={contactInfo.phone}
            onChangeText={(text) => setContactInfo({ ...contactInfo, phone: text })}
            mode="outlined"
            keyboardType="phone-pad"
            style={styles.input}
          />

          <TextInput
            label="Email"
            value={contactInfo.email}
            onChangeText={(text) => setContactInfo({ ...contactInfo, email: text })}
            mode="outlined"
            keyboardType="email-address"
            autoCapitalize="none"
            style={styles.input}
          />
        </Card.Content>
      </Card>

      {/* Special Requests */}
      <Card style={styles.section}>
        <Card.Content>
          <Title style={styles.sectionTitle}>üí¨ Solicitudes Especiales</Title>
          <TextInput
            label="Comentarios adicionales (opcional)"
            value={specialRequests}
            onChangeText={setSpecialRequests}
            mode="outlined"
            multiline
            numberOfLines={3}
            style={styles.input}
          />
        </Card.Content>
      </Card>

      {/* Price Summary */}
      <Card style={styles.section}>
        <Card.Content>
          <Title style={styles.sectionTitle}>üí∞ Resumen de Precios</Title>

          <View style={styles.priceRow}>
            <Text style={styles.priceLabel}>
              ${boat.pricePerHour} x {calculateTotalHours()} horas
            </Text>
            <Text style={styles.priceValue}>
              ${calculateTotalPrice()}
            </Text>
          </View>

          <Divider style={styles.divider} />

          <View style={styles.totalRow}>
            <Text style={styles.totalLabel}>Total</Text>
            <Text style={styles.totalValue}>${calculateTotalPrice()}</Text>
          </View>
        </Card.Content>
      </Card>

      {/* Continue Button */}
      <Button
        mode="contained"
        onPress={handleContinueToPayment}
        loading={isLoading}
        disabled={isLoading || calculateTotalPrice() === 0}
        style={styles.continueButton}
        contentStyle={styles.continueButtonContent}
      >
        Continuar al Pago
      </Button>
    </ScrollView>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f8f9fa',
  },
  boatSummary: {
    margin: 16,
    elevation: 2,
  },
  boatHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
  },
  boatInfo: {
    flex: 1,
  },
  boatName: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 4,
  },
  boatLocation: {
    fontSize: 14,
    color: '#666',
  },
  priceInfo: {
    alignItems: 'flex-end',
  },
  price: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#0066CC',
  },
  priceUnit: {
    fontSize: 12,
    color: '#666',
  },
  section: {
    margin: 16,
    marginTop: 0,
    elevation: 2,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    marginBottom: 16,
  },
  timeLabel: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 12,
    marginTop: 16,
  },
  timeSlots: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 8,
    marginBottom: 8,
  },
  timeChip: {
    marginBottom: 8,
  },
  durationInfo: {
    padding: 12,
    marginTop: 16,
    borderRadius: 8,
    backgroundColor: '#E3F2FD',
  },
  durationText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#0066CC',
    textAlign: 'center',
  },
  input: {
    marginBottom: 12,
  },
  priceRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  priceLabel: {
    fontSize: 16,
  },
  priceValue: {
    fontSize: 16,
    fontWeight: '600',
  },
  divider: {
    marginVertical: 12,
  },
  totalRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  totalLabel: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  totalValue: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#0066CC',
  },
  continueButton: {
    margin: 16,
    marginTop: 8,
  },
  continueButtonContent: {
    paddingVertical: 12,
  },
});